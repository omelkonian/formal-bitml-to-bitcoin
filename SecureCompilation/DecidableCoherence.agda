{-# OPTIONS --no-forcing #-}
open import Prelude.Init
  renaming (toWitness to _Â¡)
  hiding (T)
open SetAsType
open L.Mem
open L.All using (lookup; Â¬Anyâ‡’AllÂ¬)
open L.Any using (satisfied; lookup-index)
open import Prelude.Lists.Core
open import Prelude.Lists.Indexed
open import Prelude.Lists.Collections
open import Prelude.Lists.Mappings
open import Prelude.Lists.Membership
open import Prelude.Lists.MapMaybe
open import Prelude.Lists.Subsets
open import Prelude.General
open import Prelude.InferenceRules
open import Prelude.Lists.Dec
open import Prelude.DecEq
open import Prelude.Ord
open import Prelude.Traces
open import Prelude.Null
open import Prelude.Setoid
open import Prelude.Nary
open import Prelude.Apartness
open import Prelude.ToList
open import Prelude.Functor
open import Prelude.Membership.Patterns
open import Prelude.Membership using (_âˆˆ?_; _âˆ‰?_)
open import Prelude.Decidable

open import SecureCompilation.ModuleParameters using (â‹¯)

module SecureCompilation.DecidableCoherence (â‹¯ : â‹¯) (let open â‹¯ â‹¯) where

open import SymbolicModel â‹¯â€² as S
  hiding (d; Î“â‚œâ€³; G; C)
  renaming (_âˆ¶_â™¯_ to _âˆ¶_#_; âŸ¨_âˆ¶_â™¯_âŸ© to âŸ¨_âˆ¶_#_âŸ©)
open import ComputationalModel â‹¯â€² finPart keypairs as C
  hiding (t; tâ€²; `; âˆ£_âˆ£; n)
open import Compiler â‹¯â€² Î·
open import SecureCompilation.ComputationalContracts â‹¯â€²
open import SecureCompilation.Helpers â‹¯
open import SecureCompilation.Coherence â‹¯

[1]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
    {âŸ¨GâŸ©C : Ad} (let open âˆ£AD âŸ¨GâŸ©C)
    (let Î“â‚œ = Î“ at t)
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = advertiseâ¦… âŸ¨GâŸ©C â¦†
      Î“â€²  = ` âŸ¨GâŸ©C âˆ£ Î“
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³  {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²}  (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
    {vad? : autoâˆ¶ ValidAd âŸ¨GâŸ©C} (let vad = vad? Â¡)
    {hon? : autoâˆ¶ Any (_âˆˆ Hon) partG} (let hon = hon? Â¡)
    {dâŠ†?  : autoâˆ¶ âŸ¨GâŸ©C âŠ†â¦… deposits â¦† Î“}
    (let dâŠ† : deposits âŸ¨GâŸ©C âŠ† deposits Î“
         dâŠ† x = (dâŠ†? Â¡) x)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Action] ([C-Advertise] vad hon dâŠ†) refl

      open Hâ‚ ğ•£ t Î± tâ€² Î“ Râ‰ˆ âŸ¨GâŸ©C Î“â†’Î“â€² âˆƒÎ“â‰ˆ using (Î»Ë¢)

      C =
        let
          txoutÎ“ = Txout Î“ âˆ‹ Txoutâ‰ˆ {RË¢ âˆ™cfg}{Î“} (Râ‰ˆ .projâ‚‚) (ğ•£ âˆ™txoutEnd_)
          txoutG = Txout G âˆ‹ weaken-â†¦ txoutÎ“ (depositsâŠ†â‡’namesÊ³âŠ† {âŸ¨GâŸ©C}{Î“} dâŠ†)
          txoutC = Txout C âˆ‹ weaken-â†¦ txoutG (mapMaybe-âŠ† isInjâ‚‚ $ vad âˆ™names-âŠ†)
        in
          encodeAd âŸ¨GâŸ©C (txoutG , txoutC)
      Î»á¶œ = A â†’âˆ—âˆ¶ C
    in
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[1]â‹¯ {Râ‰ˆ? = Râ‰ˆ} _ {Î“â‰ˆ}{vad}{hon}{dâŠ†} =
  [1] (Râ‰ˆ Â¡) (-, Î“â‰ˆ Â¡) (vad Â¡) (hon Â¡) (dâŠ† Â¡)

_âˆˆHonâ‡’?All-Is-just_ : âˆ€ A ms â†’ Dec (A âˆˆ Hon â†’ All (Is-just {A = â„•}) ms)
A âˆˆHonâ‡’?All-Is-just ms
  with A âˆˆ? Hon
... | no Aâˆ‰  = yes Î» Aâˆˆ â†’ âŠ¥-elim $ Aâˆ‰ Aâˆˆ
... | yes Aâˆˆ
  with all? (M.Any.dec Î» _ â†’ yes tt) ms
... | no Â¬p = no Î» p â†’ Â¬p (p Aâˆˆ)
... | yes p = yes Î» _ â†’ p

instance
  Dec-â‰¢-â†’âˆ—âˆ¶ : (âˆ€ A â†’ Î»á¶œ â‰¢ A â†’âˆ—âˆ¶ m) â‡
  Dec-â‰¢-â†’âˆ—âˆ¶ {Î»á¶œ}{m} .dec
    with Î»á¶œ in eq
  ... | submit _ = yes Î» _ ()
  ... | delay _  = yes Î» _ ()
  ... | _ â†’Oâˆ¶ _  = yes Î» _ ()
  ... | Oâ†’ _ âˆ¶ _ = yes Î» _ ()
  ... | A â†’âˆ—âˆ¶ mâ€²
    with m â‰Ÿ mâ€²
  ... | yes refl = no Î» Â¬eq â†’ Â¬eq A refl
  ... | no mâ‰¢    = yes Î» where _ refl â†’ mâ‰¢ refl

  Dec-CheckOracle : âˆ€ {os} â†’ CheckInteractions os â‡Â¹
  Dec-CheckOracle {os} {x} .dec
    with x
  ... | _ , nothing , háµ¢ = háµ¢ âˆ‰? map selectâ‚ƒ (filter ((Î· â‰¤?_) âˆ˜ âˆ£_âˆ£áµ âˆ˜ selectâ‚‚) os)
  ... | _ , just Náµ¢ , háµ¢
    with Â¿ Any (Î» (_ , m , h) â†’ (h â‰¡ háµ¢) Ã— (âˆ£ m âˆ£áµ â‰¡ Î· + Náµ¢)) os Â¿
  ... | no  xâˆ‰ = no Î» (_ , _ , xâˆˆ , mâ‰¡) â†’ L.All.lookup (Â¬Anyâ‡’AllÂ¬ os xâˆ‰) xâˆˆ (refl , mâ‰¡)
  ... | yes xâˆˆ
    with L.Any.lookup xâˆˆ | âˆˆ-lookup {xs = os} (L.Any.index xâˆˆ) | lookup-index xâˆˆ
  ... | A , m , _ | xâˆˆ | refl , q = yes (A , m , xâˆˆ , q)

[2]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
    {âŸ¨GâŸ©C} (open âˆ£AD âŸ¨GâŸ©C)
    {Î”Ã—hÌ… : List (Secret Ã— Maybe â„• Ã— â„¤)}
    (let hÌ… = map selectâ‚ƒ Î”Ã—hÌ…
         Î” = map dropâ‚ƒ   Î”Ã—hÌ…
         (as , ms) = unzip Î”)
    {kâƒ— : ğ•‚Â²â€² âŸ¨GâŸ©C} (let kÌ… = concatMap (map pub âˆ˜ codom) $ codom kâƒ—)
  â†’ let
      Î“ = ` âŸ¨GâŸ©C âˆ£ Î“â‚€
      Î“â‚œ = Î“ at t
    in
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Râ‰ˆ  = Râ‰ˆ? Â¡

      Î”á¶œ = || map (uncurry âŸ¨ A âˆ¶_#_âŸ©) Î”

      C      = encodeAd âŸ¨GâŸ©C (adâˆˆâ‡’Txout {âŸ¨GâŸ©C}{Î“}{RË¢} ğŸ˜ Râ‰ˆ txoutâ€²)
      C,hÌ…,kÌ…  = encode (C , hÌ… , kÌ…)
      C,hÌ…,kÌ…â‚ = SIG (K A) C,hÌ…,kÌ…

      Î±   = auth-commitâ¦… A , âŸ¨GâŸ©C , Î” â¦†
      Î“â€²  = Î“ âˆ£ Î”á¶œ âˆ£ A auth[ â™¯â–· âŸ¨GâŸ©C ]
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
      Î»á¶œ  = B â†’âˆ—âˆ¶ C,hÌ…,kÌ…â‚
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , (Î“â‰ˆ? Â¡))
    {asâ‰¡?  : autoâˆ¶ as â‰¡ secretsOfáµ– A G} (let asâ‰¡  = asâ‰¡? Â¡)
    {Allâˆ‰? : autoâˆ¶ All (_âˆ‰ secretsOfá¶œá¶  A Î“â‚€) as} (let Allâˆ‰ = Allâˆ‰? Â¡)
    {Honâ‡’? : True $ A âˆˆHonâ‡’?All-Is-just ms} (let Honâ‡’ = Honâ‡’? Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Action] ([C-AuthCommit] asâ‰¡ Allâˆ‰ Honâ‡’) refl

      sechashâº : as â†¦ â„¤
      sechashâº aâˆˆ =
        let _ , aÃ—mâˆˆ , _    = âˆˆ-unzipâ»Ë¡ Î” aâˆˆ
            (_ , _ , z) , _ = âˆˆ-mapâ» dropâ‚ƒ aÃ—mâˆˆ
        in z

      open Hâ‚‚ {RË¢} ğ•£ t Î± tâ€² Î“ Râ‰ˆ A A âŸ¨GâŸ©C Î” sechashâº kâƒ— Î“â†’Î“â€² âˆƒÎ“â‰ˆ using (Î»Ë¢)
    in
  âˆ€ B {Bâˆˆ? : autoâˆ¶ (B â†’âˆ—âˆ¶ C) âˆˆ toList Rá¶œ} (let Bâˆˆ = Bâˆˆ? Â¡)
    {_ : autoâˆ¶ All (Î» l â†’ âˆ€ X â†’ l â‰¢ X â†’âˆ—âˆ¶ C) (Any-tail Bâˆˆ)}
    {_ : autoâˆ¶ All (Î» háµ¢ â†’ âˆ£ háµ¢ âˆ£á¶» â‰¡ Î·) hÌ…}
    {_ : autoâˆ¶ All (Î» l â†’ âˆ€ X â†’ l â‰¢ X â†’âˆ—âˆ¶ C,hÌ…,kÌ…â‚) (Any-front Bâˆˆ)}
    {_ : autoâˆ¶ CheckOracleInteractions Rá¶œ Î”Ã—hÌ…}
    {_ : autoâˆ¶ Unique hÌ…}
    {_ : autoâˆ¶ Disjoint hÌ… (codom sechashâ€²)} â†’
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[2]â‹¯ {Râ‰ˆ? = Râ‰ˆ} _ {Î“â‰ˆ}{asâ‰¡}{Allâˆ‰}{Honâ‡’} B {Bâˆˆ} {pâ‚} {pâ‚‚} {pâ‚ƒ} {pâ‚„} {pâ‚…} {pâ‚†} =
  [2] (Râ‰ˆ Â¡) (-, Î“â‰ˆ Â¡) (asâ‰¡ Â¡) (Allâˆ‰ Â¡) (Honâ‡’ Â¡) (-, Bâˆˆ Â¡)
             (pâ‚ Â¡) (pâ‚‚ Â¡) (pâ‚ƒ Â¡) (pâ‚„ Â¡) (pâ‚… Â¡) (pâ‚† Â¡)

[3]â‹¯ :
  âˆ€ {Î“â‚€}{t}{A}{x}{v}{B}{Rá¶œ}
    {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
    {âŸ¨GâŸ©C} (let open âˆ£AD âŸ¨GâŸ©C)

  â†’ let
      Î“ = ` âŸ¨GâŸ©C âˆ£ Î“â‚€
      Î“â‚œ = Î“ at t
    in
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = auth-initâ¦… A , âŸ¨GâŸ©C , x â¦†
      Î“â€²  = Î“ âˆ£ A auth[ x â–·Ë¢ âŸ¨GâŸ©C ]
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
    {pâ‚ : autoâˆ¶ partG âŠ†â€² committedParticipants âŸ¨GâŸ©C Î“â‚€}
    (let committedA = (pâ‚ Â¡) .unmkâŠ†)
    {pâ‚‚ : autoâˆ¶ (A , v , x) âˆˆ persistentDeposits G} (let Aâˆˆper = pâ‚‚ Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Action] ([C-AuthInit] committedA Aâˆˆper) refl

      open Hâ‚ƒ {RË¢} ğ•£ t Î± tâ€² âŸ¨GâŸ©C Î“â‚€ A x Râ‰ˆ Î“â†’Î“â€² âˆƒÎ“â‰ˆ committedA using (Î»Ë¢; T)

      m = SIG (KÌ‚ A) T
      Î»á¶œ = B â†’âˆ—âˆ¶ m
    in
  âˆ€ B {pâ‚ƒ : autoâˆ¶ (B â†’âˆ—âˆ¶ (T â™¯)) âˆˆ toList Rá¶œ}
    (let âˆƒB = (âˆƒ Î» B â†’ (B â†’âˆ—âˆ¶ (T â™¯)) âˆˆ toList Rá¶œ) âˆ‹ B , (pâ‚ƒ Â¡))
    {pâ‚„ : autoâˆ¶ All (Î» l â†’ âˆ€ X â†’ l â‰¢ X â†’âˆ—âˆ¶ m) (Any-front $ âˆƒB .projâ‚‚)} â†’
    -- (let Bâˆˆ = pâ‚ƒ Â¡)
    -- {pâ‚„ : autoâˆ¶ All (Î» l â†’ âˆ€ X â†’ l â‰¢ X â†’âˆ—âˆ¶ m) (Any-front Bâˆˆ)} â†’
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[3]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—}{âŸ¨GâŸ©C} {Râ‰ˆ? = Râ‰ˆ} Î“â€³ {Î“â‰ˆ}{pâ‚}{pâ‚‚} âˆƒB {pâ‚ƒ}{pâ‚„} =
  [3] {RË¢ = RË¢}{ğ•£âˆ—}{âŸ¨GâŸ©C} (Râ‰ˆ Â¡) (Î“â€³ , Î“â‰ˆ Â¡) ((pâ‚ Â¡) .unmkâŠ†) (pâ‚‚ Â¡) (âˆƒB , pâ‚ƒ Â¡) (pâ‚„ Â¡)

[4]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
    {âŸ¨GâŸ©C} (let open âˆ£AD âŸ¨GâŸ©C)
  â†’ let
      toSpend = persistentDeposits G
      vs      = map selectâ‚‚ toSpend
      xs      = map selectâ‚ƒ toSpend
      v       = sum vs

      Î“ = ` âŸ¨GâŸ©C âˆ£ Î“â‚€
        âˆ£ || map (Î»{ (Aáµ¢ , váµ¢ , xáµ¢) â†’ âŸ¨ Aáµ¢ has váµ¢ âŸ©at xáµ¢ âˆ£ Aáµ¢ auth[ xáµ¢ â–·Ë¢ âŸ¨GâŸ©C ] })
                  toSpend
        âˆ£ || map (_auth[ â™¯â–· âŸ¨GâŸ©C ]) partG
      Î“â‚œ = Î“ at t
    in
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = initâ¦… G , C â¦†
      Î“â€²  = âŸ¨ C , v âŸ©at z âˆ£ Î“â‚€
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
    {fresh-z? : autoâˆ¶ z âˆ‰ xs ++ ids Î“â‚€} (let fresh-z = fresh-z? Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Action] ([C-Init] fresh-z) refl

      open Hâ‚„ {RË¢} ğ•£ t Î± tâ€² âŸ¨GâŸ©C Î“â‚€ toSpend v z Râ‰ˆ Î“â†’Î“â€² âˆƒÎ“â‰ˆ using (Î»Ë¢; T)

      Î»á¶œ = submit T
    in
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[4]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—}{âŸ¨GâŸ©C} {Râ‰ˆ? = Râ‰ˆ} Î“â€³ {Î“â‰ˆ}{p} =
  [4] {RË¢ = RË¢}{ğ•£âˆ—}{âŸ¨GâŸ©C} (Râ‰ˆ Â¡) (Î“â€³ , Î“â‰ˆ Â¡) (p Â¡)

[5]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
    {i : Index c} (let open âˆ£SELECT c i)
  â†’ let
      Î“ = âŸ¨ c , v âŸ©at x âˆ£ Î“â‚€
      Î“â‚œ = Î“ at t
    in
    {Dâ‰¡A:Dâ€²? : autoâˆ¶ A âˆˆ authDecorations d} (let Dâ‰¡A:Dâ€² = Dâ‰¡A:Dâ€²? Â¡)
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = auth-controlâ¦… A , x â–· d â¦†
      Î“â€²  = âŸ¨ c , v âŸ©at x âˆ£ A auth[ x â–· d ] âˆ£ Î“â‚€
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Action] ([C-AuthControl] Dâ‰¡A:Dâ€²) refl

      open Hâ‚… {RË¢} ğ•£ t Î± tâ€² c v x Î“â‚€ A i Râ‰ˆ Î“â†’Î“â€² âˆƒÎ“â‰ˆ Dâ‰¡A:Dâ€² using (Î»Ë¢; T; pubK)

      Î»á¶œ = B â†’âˆ—âˆ¶ SIGáµ– pubK T
    in
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[5]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—}{âŸ¨GâŸ©C} {Râ‰ˆ? = Râ‰ˆ} Î“â€³ {Î“â‰ˆ} =
  [5] {RË¢ = RË¢}{ğ•£âˆ—}{âŸ¨GâŸ©C} (Râ‰ˆ Â¡) (Î“â€³ , Î“â‰ˆ Â¡)

open import Prelude.Newtype
â‰«Null : âˆ€ {A} â†’ Predâ‚€ (List A)
â‰«Null = newtypeÂ¹ Null
instance Dec-â‰«Null : âˆ€ {A} â¦ƒ _ : DecEq A â¦„ â†’ â‰«Null {A} â‡Â¹
         Dec-â‰«Null {x = xs} .dec = mk? (Null? xs)

[6]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
    {ds : DepositRefs} (let (_ , vs , xs) = unzipâ‚ƒ ds)
    {ss : List (Participant Ã— Secret Ã— â„•)} (let (_ , as , _)  = unzipâ‚ƒ ss)
    {i : Index c} (let open âˆ£SELECT c i; As , ts = decorations d)
  â†’ let
      -- (i) xs = xâ‚â‹¯xâ‚–
      Î“â‚  = || map (uncurryâ‚ƒ âŸ¨_has_âŸ©at_) ds
      Î”   = || map (uncurryâ‚ƒ _âˆ¶_#_) ss
      Î“â‚‚  = Î” âˆ£ Î“â‚€
      Î“â‚â‚‚ = Î“â‚ âˆ£ Î“â‚‚
      Î“   = âŸ¨ c , v âŸ©at y âˆ£ (Î“â‚ âˆ£ Î“â‚‚)
      Î“â‚œ  = Î“ at t
    in
    {tâ‰¡? : autoâˆ¶ t â‰¡ maximum t ts} (let tâ‰¡ = tâ‰¡? Â¡)
    {dâ‰¡? : autoâˆ¶ d â‰¡â‹¯âˆ¶ put xs &reveal as if p â‡’ câ€²} (let dâ‰¡ = dâ‰¡? Â¡)
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = putâ¦… xs , as , y â¦†
      Î“â€²  = âŸ¨ câ€² , v + sum vs âŸ©at yâ€² âˆ£ Î“â‚‚
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
    {fresh-yâ€²? : autoâˆ¶ yâ€² âˆ‰ y L.âˆ· ids Î“â‚â‚‚} (let fresh-yâ€² = fresh-yâ€²? Â¡)
    {pâŸ¦Î”âŸ§â‰¡? : autoâˆ¶ âŸ¦ p âŸ§áµ– Î” â‰¡ just true} (let pâŸ¦Î”âŸ§â‰¡ = pâŸ¦Î”âŸ§â‰¡? Â¡)
    {Asâ‰¡âˆ…? : autoâˆ¶ â‰«Null As} (let Asâ‰¡âˆ… = (Asâ‰¡âˆ…? Â¡) .unmk)
  â†’ let
      âˆ€â‰¤t : All (_â‰¤ tâ€²) ts
      âˆ€â‰¤t = âŸª (Î» â—† â†’ All (_â‰¤ â—†) ts) âŸ« tâ‰¡ ~: âˆ€â‰¤max t ts

      putâ†’ : âŸ¨ [ dâˆ— ] , v âŸ©at y âˆ£ Î“â‚â‚‚ â€”[ Î± ]â†’ Î“â€²
      putâ†’ = âŸª (Î» â—† â†’ (âŸ¨ [ â—† ] , v âŸ©at y âˆ£ (Î“â‚ âˆ£ Î“â‚‚) â€”[ Î± ]â†’ Î“â€²)) âŸ« dâ‰¡
              ~: [C-PutRev] {ds = ds} {ss = ss} fresh-yâ€² pâŸ¦Î”âŸ§â‰¡

      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Timeout] Asâ‰¡âˆ… âˆ€â‰¤t putâ†’ refl

      open Hâ‚† {RË¢} ğ•£ t Î± tâ€² c v y ds ss Î“â‚‚ câ€² yâ€² i p Râ‰ˆ Î“â†’Î“â€² âˆƒÎ“â‰ˆ dâ‰¡ using (Î»Ë¢; T)

      Î»á¶œ = submit T
    in
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[6]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—}{âŸ¨GâŸ©C} {tâ‰¡? = pâ‚}{pâ‚‚}{Râ‰ˆ} Î“â€³ {Î“â‰ˆ}{pâ‚ƒ}{pâ‚„}{pâ‚…} =
  [6] {RË¢ = RË¢}{ğ•£âˆ—}{âŸ¨GâŸ©C} (Râ‰ˆ Â¡) (pâ‚ Â¡) (pâ‚‚ Â¡) (Î“â€³ , Î“â‰ˆ Â¡) (pâ‚ƒ Â¡) (pâ‚„ Â¡) (pâ‚… Â¡)

[7]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
    {Î”Ã—hÌ… : List (Secret Ã— Maybe â„• Ã— â„¤)}
    (let Î” = map dropâ‚ƒ   Î”Ã—hÌ…
         hÌ… = map selectâ‚ƒ Î”Ã—hÌ…)
    {âŸ¨GâŸ©C} (let open âˆ£AD âŸ¨GâŸ©C) {kâƒ— : ğ•‚Â²â€² âŸ¨GâŸ©C}
  â†’ let
      Î“ = âŸ¨ A âˆ¶ a # just n âŸ© âˆ£ Î“â‚€
      Î“â‚œ = Î“ at t
    in
    {mâ‰¡ : autoâˆ¶ âˆ£ m âˆ£áµ â‰¤ Î·}
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = auth-revâ¦… A , a â¦†
      Î“â€²  = A âˆ¶ a # n âˆ£ Î“â‚€
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Action] [C-AuthRev] refl

      aâˆˆ : a âˆˆ secrets RË¢
      aâˆˆ = namesË¡â¦…endâ¦†âŠ† RË¢
          $ âˆˆnamesË¡-resp-â‰ˆ a {Î“}{cfg (RË¢ .end)} (â†­-sym $ Râ‰ˆ .projâ‚‚) ğŸ˜
    in
  âˆ€ B {_ : autoâˆ¶ (B , m , sechashâ€² {a} aâˆˆ) âˆˆ oracleInteractionsá¶œ Rá¶œ}
    {âˆƒÎ±? : autoâˆ¶ auth-commitâ¦… A , âŸ¨GâŸ©C , Î” â¦† âˆˆ labelsÊ³ RË¢}
    (let âˆƒÎ± : auth-commitâ¦… A , âŸ¨GâŸ©C , Î” â¦† âˆˆ labelsÊ³ RË¢
         âˆƒÎ± = âˆƒÎ±? Â¡)
    {_ : autoâˆ¶ a âˆˆ secrets G}
  â†’ let
      open Hâ‚‡ ğ•£ t Î± tâ€² A a n Î“â‚€ Râ‰ˆ Î“â†’Î“â€² âˆƒÎ“â‰ˆ using (Î»Ë¢)
      open Hâ‚‡â€² ğ•£ t Î± tâ€² Î” hÌ… kâƒ— âˆƒÎ± using (C,hÌ…,kÌ…)
      Î»á¶œ = B â†’âˆ—âˆ¶ m
    in
  âˆ€ Bâ€² {B? : autoâˆ¶ Bâ€² â†’âˆ—âˆ¶ C,hÌ…,kÌ… âˆˆ toList Rá¶œ} (let âˆƒB = -, B? Â¡)
    {_ : autoâˆ¶ All (Î» l â†’ âˆ€ X â†’ l â‰¢ X â†’âˆ—âˆ¶ m) (Any-front $ âˆƒB .projâ‚‚)} â†’
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[7]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—}{âŸ¨GâŸ©C} {mâ‰¡ = pâ‚}{Râ‰ˆ} Î“â€³ {Î“â‰ˆ} _ {pâ‚‚}{pâ‚ƒ}{pâ‚„} _ {pâ‚…}{pâ‚†} =
  [7] {RË¢ = RË¢}{ğ•£âˆ—}{âŸ¨GâŸ©C} (pâ‚ Â¡) (Râ‰ˆ Â¡) (Î“â€³ , Î“â‰ˆ Â¡) (pâ‚‚ Â¡) (pâ‚ƒ Â¡) (pâ‚„ Â¡) _ (pâ‚… Â¡) (pâ‚† Â¡)

[8]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
    {i : Index c} (let open âˆ£SELECT c i; As , ts = decorations d)
    {vcis : VIContracts} (let vs , cs , xs = unzipâ‚ƒ vcis; v = sum vs)
  â†’ let
      Î“ = âŸ¨ c , v âŸ©at y âˆ£ Î“â‚€
      Î“â‚œ = Î“ at t
    in
    {tâ‰¡? : autoâˆ¶ t â‰¡ maximum t ts} (let tâ‰¡ = tâ‰¡? Â¡)
    {dâ‰¡? : autoâˆ¶ d â‰¡â‹¯âˆ¶ split (zip vs cs)} (let dâ‰¡ = dâ‰¡? Â¡)
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
    {fresh-xs? : autoâˆ¶ All (_âˆ‰ y L.âˆ· ids Î“â‚€) xs} (let fresh-xs = fresh-xs? Â¡)
    {Asâ‰¡âˆ…? : autoâˆ¶ Null As} (let Asâ‰¡âˆ… = Asâ‰¡âˆ…? Â¡)
  â†’ let
      Î±   = splitâ¦… y â¦†
      Î“â€²  = || map (uncurryâ‚ƒ $ flip âŸ¨_,_âŸ©at_) vcis âˆ£ Î“â‚€
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
  â†’ let
      âˆ€â‰¤t : All (_â‰¤ tâ€²) ts
      âˆ€â‰¤t = âŸª (Î» â—† â†’ All (_â‰¤ â—†) ts) âŸ« tâ‰¡ ~: âˆ€â‰¤max t ts

      splitâ†’ : âŸ¨ [ dâˆ— ] , v âŸ©at y âˆ£ Î“â‚€ â€”[ Î± ]â†’ Î“â€²
      splitâ†’ = âŸª (Î» â—† â†’ âŸ¨ [ â—† ] , v âŸ©at y âˆ£ Î“â‚€ â€”[ Î± ]â†’ Î“â€²) âŸ« dâ‰¡
            ~: [C-Split] {vcis = vcis} fresh-xs

      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Timeout] Asâ‰¡âˆ… âˆ€â‰¤t splitâ†’ refl

      open Hâ‚ˆ {RË¢} ğ•£ t Î± tâ€² c v y Î“â‚€ i vcis Râ‰ˆ Î“â†’Î“â€² âˆƒÎ“â‰ˆ dâ‰¡ using (Î»Ë¢; T)

      Î»á¶œ = submit T
    in
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[8]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—}{âŸ¨GâŸ©C} {tâ‰¡? = pâ‚}{pâ‚‚}{Râ‰ˆ}{pâ‚ƒ}{pâ‚„} Î“â€³ {Î“â‰ˆ} =
  [8] {RË¢ = RË¢}{ğ•£âˆ—}{âŸ¨GâŸ©C} (pâ‚ Â¡) (Râ‰ˆ Â¡) (pâ‚‚ Â¡) (pâ‚ƒ Â¡) (pâ‚„ Â¡) (Î“â€³ , Î“â‰ˆ Â¡)

[9]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
    {i : Index c} (let open âˆ£SELECT c i; As , ts = decorations d)
  â†’ let
      Î“ = âŸ¨ c , v âŸ©at y âˆ£ Î“â‚€
      Î“â‚œ = Î“ at t
    in
    {dâ‰¡? : autoâˆ¶ d â‰¡â‹¯âˆ¶ withdraw A} (let dâ‰¡ = dâ‰¡? Â¡)
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = withdrawâ¦… A , v , y â¦†
      Î“â€²  = âŸ¨ A has v âŸ©at x âˆ£ Î“â‚€
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
    {fresh-x? : autoâˆ¶ x âˆ‰ y L.âˆ· ids Î“â‚€} (let fresh-x = fresh-x? Â¡)
    {Asâ‰¡âˆ…? : autoâˆ¶ â‰«Null As} (let Asâ‰¡âˆ… = (Asâ‰¡âˆ…? Â¡) .unmk)
    {âˆ€â‰¤t? : autoâˆ¶ All (_â‰¤ t) ts} (let âˆ€â‰¤t = âˆ€â‰¤t? Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Timeout] Asâ‰¡âˆ… âˆ€â‰¤t
        (âŸª (Î» â—† â†’ âŸ¨ [ â—† ] , v âŸ©at y âˆ£ Î“â‚€ â€”[ Î± ]â†’ Î“â€²) âŸ« dâ‰¡ ~: [C-Withdraw] fresh-x)
        refl

      open Hâ‚‰ {RË¢} ğ•£ t Î± tâ€² c v y Î“â‚€ A x i Râ‰ˆ Î“â†’Î“â€² âˆƒÎ“â‰ˆ dâ‰¡ using (Î»Ë¢; T)

      Î»á¶œ = submit T
    in
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[9]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—}{âŸ¨GâŸ©C} {dâ‰¡? = pâ‚}{Râ‰ˆ} Î“â€³ {Î“â‰ˆ}{pâ‚‚}{pâ‚ƒ}{pâ‚„} =
  [9] {RË¢ = RË¢}{ğ•£âˆ—}{âŸ¨GâŸ©C} (pâ‚ Â¡) (Râ‰ˆ Â¡) (Î“â€³ , Î“â‰ˆ Â¡) (pâ‚‚ Â¡) (pâ‚ƒ Â¡) (pâ‚„ Â¡)

[10]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
  â†’ let
      Î“ = âŸ¨ A has v âŸ©at x âˆ£ âŸ¨ A has vâ€² âŸ©at xâ€² âˆ£ Î“â‚€
      Î“â‚œ = Î“ at t
    in
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = auth-joinâ¦… A , x â†” xâ€² â¦†
      Î“â€²  = âŸ¨ A has v âŸ©at x âˆ£ âŸ¨ A has vâ€² âŸ©at xâ€² âˆ£ A auth[ x â†” xâ€² â–·âŸ¨ A , v + vâ€² âŸ© ] âˆ£ Î“â‚€
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Action] [DEP-AuthJoin] refl

      nâŠ† : Î“ âŠ†â¦… ids â¦† RË¢
      nâŠ†  = namesÊ³â¦…endâ¦†âŠ† RË¢ âˆ˜ âˆˆnamesÊ³-resp-â‰ˆ _ {Î“}{RË¢ âˆ™cfg} (â†­-sym $ Râ‰ˆ .projâ‚‚)
    in
  âˆ€ B T {BT? : autoâˆ¶ flip Any (toList Rá¶œ) $ Î» l â†’
               (l â‰¡ B â†’âˆ—âˆ¶ (T â™¯))
             Ã— (inputs  T â‰¡ (hashTxâ± <$> [ txoutâ€² {x} (nâŠ† ğŸ˜) â¨¾ txoutâ€² {xâ€²} (nâŠ† ğŸ™) ]))
             Ã— (outputs T â‰¡ [ (v + vâ€²) redeemable-by KÌ‚ A ])}
    (let âˆƒB : âˆƒ Î» B â†’ âˆƒ Î» T â†’ flip Any (toList Rá¶œ) $ Î» l â†’
              (l â‰¡ B â†’âˆ—âˆ¶ (T â™¯))
            Ã— (inputs  T â‰¡ (hashTxâ± <$> [ txoutâ€² {x} (nâŠ† ğŸ˜) â¨¾ txoutâ€² {xâ€²} (nâŠ† ğŸ™) ]))
            Ã— (outputs T â‰¡ [ (v + vâ€²) redeemable-by KÌ‚ A ])
         âˆƒB = B , T , BT? Â¡)
  â†’ let
      T : âˆƒTx
      T = 2 , 1 , âˆƒB .projâ‚‚ .projâ‚

      mâ€² = SIG (KÌ‚ A) T
      Î»á¶œ = B â†’âˆ—âˆ¶ mâ€²

      open Hâ‚â‚€ {RË¢} ğ•£ t Î± tâ€² A v x vâ€² xâ€² Î“â‚€ Râ‰ˆ Î“â†’Î“â€² âˆƒÎ“â‰ˆ using (Î»Ë¢)
    in
    {_ : autoâˆ¶ All (Î» l â†’ âˆ€ B â†’ l â‰¢ B â†’âˆ—âˆ¶ mâ€²) (Any-front $ âˆƒB .projâ‚‚ .projâ‚‚)} â†’
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[10]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—} {Râ‰ˆ? = Râ‰ˆ} Î“â€³ {Î“â‰ˆ} B T {pâ‚}{pâ‚‚} =
  [10] {RË¢ = RË¢}{ğ•£âˆ—} (Râ‰ˆ Â¡) (Î“â€³ , Î“â‰ˆ Â¡) (B , T , pâ‚ Â¡) (pâ‚‚ Â¡)

[11]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
  â†’ let
      Î“ = âŸ¨ A has v âŸ©at x âˆ£ âŸ¨ A has vâ€² âŸ©at xâ€²
        âˆ£ A auth[ x â†” xâ€² â–·âŸ¨ A , v + vâ€² âŸ© ] âˆ£ Î“â‚€
      Î“â‚œ = Î“ at t
    in
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = joinâ¦… x â†” xâ€² â¦†
      Î“â€²  = âŸ¨ A has (v + vâ€²) âŸ©at y âˆ£ Î“â‚€
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
    {fresh-y? : autoâˆ¶ y âˆ‰ x L.âˆ· xâ€² âˆ· ids Î“â‚€}
    (let fresh-y = fresh-y? Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Action] ([DEP-Join] fresh-y) refl

      nâŠ† : Î“ âŠ†â¦… ids â¦† RË¢
      nâŠ†  = namesÊ³â¦…endâ¦†âŠ† RË¢ âˆ˜ âˆˆnamesÊ³-resp-â‰ˆ _ {Î“}{RË¢ âˆ™cfg} (â†­-sym $ Râ‰ˆ .projâ‚‚)

      T : âˆƒTx
      T  = 2 , 1 , sigâ‹† (V.replicate [ KÌ‚ A ]) record
        { inputs  = hashTxâ± <$> [ txoutâ€² {x} (nâŠ† ğŸ˜) â¨¾ txoutâ€² {xâ€²} (nâŠ† ğŸ™) ]
        ; wit     = witâŠ¥
        ; relLock = V.replicate 0
        ; outputs = [ (v + vâ€²) redeemable-by KÌ‚ A ]
        ; absLock = 0 }
      Î»á¶œ = submit T

      open Hâ‚â‚ {RË¢} ğ•£ t Î± tâ€² A v x vâ€² xâ€² y Î“â‚€ Râ‰ˆ (T at 0F) Î“â†’Î“â€² âˆƒÎ“â‰ˆ using (Î»Ë¢)
    in
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[11]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—} {Râ‰ˆ? = Râ‰ˆ} Î“â€³ {Î“â‰ˆ} {pâ‚} =
  [11] {RË¢ = RË¢}{ğ•£âˆ—} (Râ‰ˆ Â¡) (Î“â€³ , Î“â‰ˆ Â¡) (pâ‚ Â¡)

[12]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
  â†’ let
      Î“ = âŸ¨ A has (v + vâ€²) âŸ©at x âˆ£ Î“â‚€
      Î“â‚œ = Î“ at t
    in
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = auth-divideâ¦… A , x â–· v , vâ€² â¦†
      Î“â€²  = âŸ¨ A has (v + vâ€²) âŸ©at x âˆ£ A auth[ x â–·âŸ¨ A , v , vâ€² âŸ© ] âˆ£ Î“â‚€
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Action] [DEP-AuthDivide] refl

      nâŠ† : Î“ âŠ†â¦… ids â¦† RË¢
      nâŠ†  = namesÊ³â¦…endâ¦†âŠ† RË¢
          âˆ˜ âˆˆnamesÊ³-resp-â‰ˆ _ {Î“}{RË¢ âˆ™cfg} (â†­-sym $ Râ‰ˆ .projâ‚‚)
    in
  âˆ€ B T {BT? : autoâˆ¶ flip Any (toList Rá¶œ) $ Î» l â†’
               (l â‰¡ B â†’âˆ—âˆ¶ (T â™¯))
             Ã— (inputs  T â‰¡ [ hashTxâ± (txoutâ€² {x} $ nâŠ† ğŸ˜) ])
             Ã— (outputs T â‰¡ [ v redeemable-by KÌ‚ A â¨¾ vâ€² redeemable-by KÌ‚ A ])}
        (let âˆƒB = B , T , BT? Â¡)
  â†’ let
      T : âˆƒTx
      T = 1 , 2 , âˆƒB .projâ‚‚ .projâ‚

      mâ€² = SIG (KÌ‚ A) T
      Î»á¶œ = B â†’âˆ—âˆ¶ mâ€²

      open Hâ‚â‚‚ {RË¢} ğ•£ t Î± tâ€² A v vâ€² x Î“â‚€ Râ‰ˆ Î“â†’Î“â€² âˆƒÎ“â‰ˆ using (Î»Ë¢)
    in
    {_ : autoâˆ¶ All (Î» l â†’ âˆ€ B â†’ l â‰¢ B â†’âˆ—âˆ¶ mâ€²) (Any-front $ âˆƒB .projâ‚‚ .projâ‚‚)} â†’
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[12]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—} {Râ‰ˆ? = Râ‰ˆ} Î“â€³ {Î“â‰ˆ} B T {pâ‚}{pâ‚‚} =
  [12] {RË¢ = RË¢}{ğ•£âˆ—} (Râ‰ˆ Â¡) (Î“â€³ , Î“â‰ˆ Â¡) (B , T , pâ‚ Â¡) (pâ‚‚ Â¡)

[13]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
  â†’ let
      Î“ = âŸ¨ A has (v + vâ€²) âŸ©at x âˆ£ A auth[ x â–·âŸ¨ A , v , vâ€² âŸ© ] âˆ£ Î“â‚€
      Î“â‚œ = Î“ at t
    in
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = divideâ¦… x â–· v , vâ€² â¦†
      Î“â€²  = âŸ¨ A has v âŸ©at y âˆ£ âŸ¨ A has vâ€² âŸ©at yâ€² âˆ£ Î“â‚€
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
    {fresh-ys? : autoâˆ¶ All (_âˆ‰ x L.âˆ· ids Î“â‚€ ) [ y â¨¾ yâ€² ]}
    (let fresh-ys = fresh-ys? Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Action] ([DEP-Divide] fresh-ys) refl

      nâŠ† : Î“ âŠ†â¦… ids â¦† RË¢
      nâŠ† = namesÊ³â¦…endâ¦†âŠ† RË¢ âˆ˜ âˆˆnamesÊ³-resp-â‰ˆ _ {Î“}{RË¢ âˆ™cfg} (â†­-sym $ Râ‰ˆ .projâ‚‚)

      T  = 1 , 2 , sigâ‹† (V.replicate [ KÌ‚ A ]) record
        { inputs  = [ hashTxâ± (txoutâ€² {x} $ nâŠ† ğŸ˜) ]
        ; wit     = witâŠ¥
        ; relLock = V.replicate 0
        ; outputs = [ v redeemable-by KÌ‚ A â¨¾ vâ€² redeemable-by KÌ‚ A ]
        ; absLock = 0 }
      Î»á¶œ = submit T

      open Hâ‚â‚ƒ {RË¢} ğ•£ t Î± tâ€² A v vâ€² x Î“â‚€ y yâ€² Râ‰ˆ (T at 0F) (T at 1F) Î“â†’Î“â€² âˆƒÎ“â‰ˆ using (Î»Ë¢)
    in
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[13]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—} {Râ‰ˆ? = Râ‰ˆ} Î“â€³ {Î“â‰ˆ} {pâ‚} =
  [13] {RË¢ = RË¢}{ğ•£âˆ—} (Râ‰ˆ Â¡) (Î“â€³ , Î“â‰ˆ Â¡) (pâ‚ Â¡)

[14]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
  â†’ let
      Î“ = âŸ¨ A has v âŸ©at x âˆ£ Î“â‚€
      Î“â‚œ = Î“ at t
    in
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = auth-donateâ¦… A , x â–·áµˆ Bâ€² â¦†
      Î“â€²  = âŸ¨ A has v âŸ©at x âˆ£ A auth[ x â–·áµˆ Bâ€² ] âˆ£ Î“â‚€
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Action] [DEP-AuthDonate] refl

      nâŠ† : Î“ âŠ†â¦… ids â¦† RË¢
      nâŠ†  = namesÊ³â¦…endâ¦†âŠ† RË¢ âˆ˜ âˆˆnamesÊ³-resp-â‰ˆ _ {Î“}{RË¢ âˆ™cfg} (â†­-sym $ Râ‰ˆ .projâ‚‚)
    in
  âˆ€ B T {BT? : autoâˆ¶ flip Any (toList Rá¶œ) $ Î» l â†’
            (l â‰¡ B â†’âˆ—âˆ¶ (T â™¯))
          Ã— (inputs  T â‰¡ [ hashTxâ± (txoutâ€² {x} $ nâŠ† ğŸ˜) ])
          Ã— (outputs T â‰¡ [ v redeemable-by KÌ‚ B ])}
        (let âˆƒB = B , T , BT? Â¡)
  â†’ let
      T : âˆƒTx
      T = 1 , 1 , âˆƒB .projâ‚‚ .projâ‚

      mâ€² = SIG (KÌ‚ A) T
      Î»á¶œ = B â†’âˆ—âˆ¶ mâ€²

      open Hâ‚â‚„ {RË¢} ğ•£ t Î± tâ€² A v x Î“â‚€ Bâ€² Râ‰ˆ Î“â†’Î“â€² âˆƒÎ“â‰ˆ using (Î»Ë¢)
    in
    {_ : autoâˆ¶ All (Î» l â†’ âˆ€ B â†’ l â‰¢ B â†’âˆ—âˆ¶ mâ€²) (Any-front $ âˆƒB .projâ‚‚ .projâ‚‚)} â†’
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[14]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—} {Râ‰ˆ? = Râ‰ˆ} Î“â€³ {Î“â‰ˆ} B T {pâ‚}{pâ‚‚} =
  [14] {RË¢ = RË¢}{ğ•£âˆ—} (Râ‰ˆ Â¡) (Î“â€³ , Î“â‰ˆ Â¡) (B , T , pâ‚ Â¡) (pâ‚‚ Â¡)

[15]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
  â†’ let
      Î“ = âŸ¨ A has v âŸ©at x âˆ£ A auth[ x â–·áµˆ Bâ€² ] âˆ£ Î“â‚€
      Î“â‚œ = Î“ at t
    in
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = donateâ¦… x â–·áµˆ Bâ€² â¦†
      Î“â€²  = âŸ¨ Bâ€² has v âŸ©at y âˆ£ Î“â‚€
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
    {fresh-y? : autoâˆ¶ y âˆ‰ x L.âˆ· ids Î“â‚€} (let fresh-y = fresh-y? Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Action] ([DEP-Donate] fresh-y) refl

      nâŠ† : Î“ âŠ†â¦… ids â¦† RË¢
      nâŠ†  = namesÊ³â¦…endâ¦†âŠ† RË¢ âˆ˜ âˆˆnamesÊ³-resp-â‰ˆ _ {Î“}{RË¢ âˆ™cfg} (â†­-sym $ Râ‰ˆ .projâ‚‚)

      -- (iii) submit transaction T
      T  = 1 , 1 , sigâ‹† (V.replicate [ KÌ‚ A ]) record
        { inputs  = [ hashTxâ± (txoutâ€² {x} $ nâŠ† ğŸ˜) ]
        ; wit     = witâŠ¥
        ; relLock = V.replicate 0
        ; outputs = [ v redeemable-by KÌ‚ Bâ€² ]
        ; absLock = 0 }
      Î»á¶œ = submit T

      -- (v) extend txoutâ€² with yâ†¦Tâ‚€ (removing xâ†¦Tâ‚€), sechash = sechashâ€², Îº = Îºâ€²
      open Hâ‚â‚… {RË¢} ğ•£ t Î± tâ€² A v x Bâ€² Î“â‚€ y Râ‰ˆ (T at 0F) Î“â†’Î“â€² âˆƒÎ“â‰ˆ using (Î»Ë¢)
    in
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[15]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—} {Râ‰ˆ? = Râ‰ˆ} Î“â€³ {Î“â‰ˆ} {pâ‚} =
  [15] {RË¢ = RË¢}{ğ•£âˆ—} (Râ‰ˆ Â¡) (Î“â€³ , Î“â‰ˆ Â¡) (pâ‚ Â¡)

instance
  Dec-â‰â‚â‚ : âˆ€ {Î»Ë¢ RË¢ Î»á¶œ Rá¶œ} {ğ•£âˆ— : â„âˆ— RË¢} â†’
    (âˆ€ Î“â‚œâ€² (Î»Ë¢â€² : ğ•ƒ RË¢ Î“â‚œâ€²)
      â†’ Î»Ë¢â€² .projâ‚ .projâ‚ â‰¢ Î»Ë¢ .projâ‚ .projâ‚
      â†’ (Î“â‚œâ€² âˆ· ğ•£âˆ— âŠ£ Î»Ë¢â€² âœ“) â‰â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)) â‡
  Dec-â‰â‚â‚ {Î»Ë¢}{RË¢}{Î»á¶œ}{Rá¶œ}{ğ•£âˆ—} .dec = {!!}

[16]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
    {ds : DepositRefs} (let k = length ds; xs = map (projâ‚‚ âˆ˜ projâ‚‚) ds)
    {j : Index ds} (let A = (ds â€¼ j) .projâ‚; jâ€² = â€¼-map {xs = ds} j)
  â†’ let
      Î”  = || map (uncurryâ‚ƒ âŸ¨_has_âŸ©at_) ds
      Î“  = Î” âˆ£ Î“â‚€
      Î“â‚œ = Î“ at t
    in
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = auth-destroyâ¦… A , xs , jâ€² â¦†
      Î“â€²  = Î” âˆ£ A auth[ xs , jâ€² â–·áµˆË¢ y ] âˆ£ Î“â‚€
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
    {fresh-y? : autoâˆ¶ y âˆ‰ ids Î“â‚€} (let fresh-y = fresh-y? Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Action] ([DEP-AuthDestroy] fresh-y) refl

      open Hâ‚â‚† {RË¢} ğ•£ t Î± tâ€² ds Î“â‚€  j A y Râ‰ˆ Î“â†’Î“â€² âˆƒÎ“â‰ˆ using (Î»Ë¢; xsâ†¦)
    in
  âˆ€ (T : Tx i 0)
    {_ : autoâˆ¶ (hashTxâ± <$> codom xsâ†¦) âŠ†â€² V.toList (inputs T)}
    B {Tâˆˆ? : autoâˆ¶ (B â†’âˆ—âˆ¶ (T â™¯)) âˆˆ toList Rá¶œ} (let Tâˆˆ = Tâˆˆ? Â¡)
    (let Tâˆˆ = Tâˆˆ? Â¡)
  â†’ let
      m = SIG (KÌ‚ A) T
      Î»á¶œ = B â†’âˆ—âˆ¶ m
    in
    {_ : autoâˆ¶ All (Î» l â†’ âˆ€ B â†’ l â‰¢ B â†’âˆ—âˆ¶ m) (Any-front Tâˆˆ)}
    {_ : autoâˆ¶ âˆ€ Î“â‚œâ€² (Î»Ë¢â€² : ğ•ƒ RË¢ Î“â‚œâ€²)
      â†’ Î»Ë¢â€² .projâ‚ .projâ‚ â‰¢ Î»Ë¢ .projâ‚ .projâ‚
      â†’ (Î“â‚œâ€² âˆ· ğ•£âˆ— âŠ£ Î»Ë¢â€² âœ“) â‰â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)} â†’
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[16]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—}{ds}{j} {Râ‰ˆ? = Râ‰ˆ} Î“â€³ {Î“â‰ˆ} {pâ‚} T {pâ‚‚} B {pâ‚ƒ}{pâ‚„}{pâ‚…} =
  [16] {RË¢ = RË¢}{ğ•£âˆ—}{ds}{j} (Râ‰ˆ Â¡) (Î“â€³ , Î“â‰ˆ Â¡) (pâ‚ Â¡) T ((pâ‚‚ Â¡) .unmkâŠ†) (B , pâ‚ƒ Â¡) (pâ‚„ Â¡) (pâ‚… Â¡)

[17]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
    {ds : DepositRefs} (let xs = map (projâ‚‚ âˆ˜ projâ‚‚) ds)
    {j : Index ds}
  â†’ let
      Î”  = || flip map (enumerate ds) (Î»{ (i , Aáµ¢ , váµ¢ , xáµ¢) â†’
                âŸ¨ Aáµ¢ has váµ¢ âŸ©at xáµ¢ âˆ£ Aáµ¢ auth[ xs , â€¼-map {xs = ds} i â–·áµˆË¢ y ] })
      Î“  = Î” âˆ£ Î“â‚€
      Î“â‚œ = Î“ at t
    in
    {Râ‰ˆ? : autoâˆ¶ RË¢ â‰ˆâ‹¯ Î“â‚œ} (let Râ‰ˆ = Râ‰ˆ? Â¡)
  â†’ let
      Î±   = destroyâ¦… xs â¦†
      Î“â€²  = Î“â‚€
      tâ€²  = t
      Î“â‚œâ€² = Î“â€² at tâ€²
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“â€²} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Action] [DEP-Destroy] refl

      open Hâ‚â‚‡ {RË¢} ğ•£ t Î± tâ€² ds Î“â‚€ y Râ‰ˆ Î“â†’Î“â€² âˆƒÎ“â‰ˆ using (Î»Ë¢; xsâ†¦)
    in
  âˆ€ (T : Tx i 0)
    {_ : autoâˆ¶ (hashTxâ± <$> codom xsâ†¦) âŠ†â€² V.toList (inputs T)}
  â†’ let
      Î»á¶œ = submit (_ , _ , T)
    in
    {_ : autoâˆ¶ âˆ€ Î“â‚œâ€² (Î»Ë¢â€² : ğ•ƒ RË¢ Î“â‚œâ€²)
      â†’ Î»Ë¢â€² .projâ‚ .projâ‚ â‰¢ Î»Ë¢ .projâ‚ .projâ‚
      â†’ (Î“â‚œâ€² âˆ· ğ•£âˆ— âŠ£ Î»Ë¢â€² âœ“) â‰â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)} â†’
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[17]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—}{ds}{j} {Râ‰ˆ? = Râ‰ˆ} Î“â€³ {Î“â‰ˆ} T {pâ‚}{pâ‚‚} =
  [17] {RË¢ = RË¢}{ğ•£âˆ—}{ds}{j} (Râ‰ˆ Â¡) (Î“â€³ , Î“â‰ˆ Â¡) T ((pâ‚ Â¡) .unmkâŠ†) (pâ‚‚ Â¡)

[18]â‹¯ :
  âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} (let ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—; open â„ ğ•£)
    (Î´>0 : Î´ > 0)
  â†’ let
      Î“â‚œ@(Î“ at t) = RË¢ .end
      Î±   = delayâ¦… Î´ â¦†
      tâ€²  = t + Î´
      Î“â‚œâ€² = Î“ at tâ€²
      Î»á¶œ  = delay Î´
    in
  âˆ€ Î“â€³ {Î“â‰ˆ? : autoâˆ¶ Î“â€³ â‰ˆá¶œ Î“} (let Î“â‚œâ€³ = Î“â€³ at tâ€²; âˆƒÎ“â‰ˆ = Î“â€³ , Î“â‰ˆ? Â¡)
  â†’ let
      Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
      Î“â†’Î“â€² = [Delay] Î´>0

      open Hâ‚â‚ˆ {RË¢} ğ•£ t Î± tâ€² Î“ (â‰ˆáµ—-refl {Î“â‚œ}) Î“â†’Î“â€² âˆƒÎ“â‰ˆ using (Î»Ë¢)
    in
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (Î“â‚œâ€³ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â‚â‚ (Î»á¶œ âˆ· Rá¶œ âœ“)
[18]â‹¯ {RË¢ = RË¢}{ğ•£âˆ—} Î´>0 Î“â€³ {Î“â‰ˆ} =
  [18] {RË¢ = RË¢}{ğ•£âˆ—} Î´>0 (Î“â€³ , Î“â‰ˆ Â¡)
