-- {-# OPTIONS --allow-unsolved-metas #-}
open import Prelude.Init
open import Prelude.Lists
open import Prelude.DecEq
open import Prelude.Traces
open import Prelude.Membership
open import Prelude.ToN
open import Prelude.General
open import Prelude.ToList
open import Prelude.Sets hiding (toList)
open import Prelude.Functor
open import Prelude.InferenceRules
open import Prelude.Sets
open import Prelude.Accessors


open import Bitcoin using (KeyPair)

module SecureCompilation.Lemma6
  (Participant : Set)
  â¦ƒ _ : DecEq Participant â¦„
  (Honest : Listâº Participant)

  (finPart : Finite Participant)
  (keypairs : âˆ€ (A : Participant) â†’ KeyPair Ã— KeyPair)

  (Î· : â„•) -- security parameter
  where

open import SymbolicModel Participant Honest as S
  hiding (d; Î±; Î“; Î“â€²; Î“â€³; Î“â‚œ; Î“â‚œâ€²; t; tâ€²)
open import ComputationalModel Participant Honest finPart keypairs as C
  hiding (âˆ£_âˆ£; `; t; tâ€²)
open import SecureCompilation.Compiler Participant Honest Î·
open import SecureCompilation.Coherence Participant Honest finPart keypairs Î·

-- âˆƒdeposit : Blockchain â†’ â„ RË¢ â†’ RË¢ â‰ˆâ‹¯ âŸ¨ c , v âŸ©at x â‹¯ â†’ Set
-- âˆƒdeposit {RË¢}{c}{v} ğ•“ ğ•£ câˆˆ =
--     -- There exists a transaction output (T, o)...
--   âˆƒ Î» (txi : TxInputâ€²) â†’ let (_ , _ , T) at o = txi; Tâ‚’ = T â™¯ at toâ„• o in
--         -- ...unspent in ğ•“...
--         (Tâ‚’ âˆˆË¢ UTXO ğ•“)
--         -- ...with value v.
--       Ã— ((T â€¼áµ’ o) .projâ‚‚ .value â‰¡ v)
--         -- Further, T is generated by...
--       Ã— let
--           Î“â‚œ = RË¢ .end
--           âŸ¨GâŸ©C , _ , adâˆˆ , câŠ† , anc = ANCESTOR {RË¢}{c = c} {Î“ = Î“â‚œ .cfg} (â‰ˆáµ—-refl {Î“â‚œ}) câˆˆ

--           K : ğ•‚ (âŸ¨GâŸ©C .G)
--           K {p} _ = KÌ‚ p

--           vad , txout , sechash , Îº = LIFTá¶œ ğ•£ anc
--           -- ...invoking the compiler as...
--           Tâ‚€ , ğ•” = bitml-compiler {ad = âŸ¨GâŸ©C} vad sechash txout K Îº
--         in
--           -- ...the initial transaction...
--           (T â™¯ â‰¡ Tâ‚€ .projâ‚‚ â™¯)
--           -- ...or retrieving the transaction for a specific subterm.
--         âŠ âˆƒ Î» (eq : length c â‰¡ V.length (T .outputs)) â†’
--           let
--             i : Index c
--             i = âŸª Fin âŸ« eq ~: o

--             open âˆ£SELECT c i

--             âˆƒtx : âˆƒTxá¶œ dâˆ—
--             âˆƒtx = ğ•” $ h-subá¶œ {ds = âŸ¨GâŸ©C .C} $ câŠ† (L.Mem.âˆˆ-lookup i)
--           in
--             T â™¯ â‰¡ âˆƒtx .projâ‚‚ â™¯

unquoteDecl _âˆ™Value _âˆ™value âˆ™value=_ = genAccessor _âˆ™Value _âˆ™value âˆ™value=_ (quote C.Value)
instance
  TxOutputâˆ™Value : TxOutput ctx âˆ™Value
  TxOutputâˆ™Value = âˆ™value= value

  âˆƒTxOutputâˆ™Value : âˆƒTxOutput âˆ™Value
  âˆƒTxOutputâˆ™Value = âˆ™value= Î» where (_ , txo) â†’ txo âˆ™value

  TxInputâ€²âˆ™Value : TxInputâ€² âˆ™Value
  TxInputâ€²âˆ™Value = âˆ™value= Î» where ((_ , _ , T) at o) â†’ (T â€¼áµ’ o) âˆ™value

unquoteDecl _âˆ™Run _âˆ™run âˆ™run=_ = genAccessor _âˆ™Run _âˆ™run âˆ™run=_ (quote S.Run)

-- instance
--    â„Ë¢-has-Run : â„âˆ— RË¢ âˆ™Run
--    â„Ë¢-has-Run = âˆ™run= Î» where (_â¦Š_ R {Î“} (ğ•’ , _)) â†’ Î“ âˆ· R âŠ£ ğ•’

   -- âˆƒâ„-has-Run : (âˆƒ â„) âˆ™Run
   -- âˆƒâ„-has-Run = âˆ™run= projâ‚

   -- â„Ë¢-has-â„ : HasFieldâ€² â„Ë¢ (â„ âˆ˜ _âˆ™run)
   -- â„Ë¢-has-â„ ._âˆ™ (_ â¦Š _ , ğ•£) = ğ•£

txout-preserves-value : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} â†’
  âˆ™ ğ•£âˆ— ~â€² Rá¶œ
  â†’ (câˆˆ : RË¢ â‰ˆâ‹¯ âŸ¨ c , v âŸ©at x â‹¯) â†’
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ((â„âˆ—â‡’â„ ğ•£âˆ—) âˆ™txoutC câˆˆ) âˆ™value â‰¡ v
txout-preserves-value
  {c = c} {v} {x}
  (stepâ‚ {RË¢ = RË¢}{Î“â‚œâ‚€@(Î“â‚€ at t)}{Rá¶œ}{Î»á¶œ} {ğ•£âˆ—}{ğ•’â„½}
         RË¢~Rá¶œ
         ([L]_ {.RË¢}{.Î“â‚œâ‚€}{.Î»á¶œ}{.Rá¶œ}
               ([1] {.RË¢}{âŸ¨GâŸ©C}{Î“}{.t}
                    Râ‰ˆ âˆƒÎ“â‰ˆ vad hon dâŠ†)))
  câˆˆ
  = qed
  where
    ğ•£ = â„âˆ—â‡’â„ ğ•£âˆ—

    Î“â‚œ  = Î“ at t
    Î±   = advertiseâ¦… âŸ¨GâŸ©C â¦†
    Î“â€²  = ` âŸ¨GâŸ©C âˆ£ Î“
    tâ€²  = t
    Î“â‚œâ€² = Î“â€² at tâ€²
    Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
    Î“â†’Î“â€² = [Action] ([C-Advertise] vad hon dâŠ†) refl

    open Hâ‚ ğ•£ t Î± tâ€² Î“ Râ‰ˆ âŸ¨GâŸ©C Î“â†’Î“â€² âˆƒÎ“â‰ˆ
      using (ğ•£â€²; câˆˆâ‡; txoutEndCâ‰¡)

    Î“â€³ = âˆƒÎ“â‰ˆ .projâ‚ -- : Cfg
    Î“â‰ˆ = âˆƒÎ“â‰ˆ .projâ‚‚ -- : Î“â€³ â‰ˆ Î“â€²

    câˆˆRË¢ : RË¢ â‰ˆâ‹¯ âŸ¨ c , v âŸ©at x â‹¯
    câˆˆRË¢ = câˆˆâ‡ câˆˆ

    H : (ğ•£ âˆ™txoutC câˆˆRË¢) âˆ™value â‰¡ v
    H = txout-preserves-value RË¢~Rá¶œ câˆˆRË¢

    eq : ğ•£ âˆ™txoutC câˆˆRË¢ â‰¡ ğ•£â€² âˆ™txoutC câˆˆ
    eq = sym $ txoutEndCâ‰¡ câˆˆ

    qed : (ğ•£â€² âˆ™txoutC câˆˆ) âˆ™value â‰¡ v
    qed = subst (Î» â—† â†’ â—† âˆ™value â‰¡ v) eq H

txout-preserves-value _ _ = {!!}

{-
txout-preserves-valueâ‚ {c = c}{v}{x} coh câˆˆ
  -- = case coh of Î» where
  --     ([L] [1]  Râ‰ˆ âˆƒÎ“â‰ˆ vad hon d) â†’ txout-preserves-valueâ‚ coh (there câˆˆ)
  --     _ â†’ ?
  with coh
... | [L] [1] {RË¢}{âŸ¨GâŸ©C}{Î“}{t}{ğ•£ = ğ•£} Râ‰ˆ âˆƒÎ“â‰ˆ vad hon dâŠ† = {!!} -- txout-preserves-valueâ‚ coh câˆˆâ€²
  where
    Î“â‚œ  = Î“ at t
    Î±   = advertiseâ¦… âŸ¨GâŸ©C â¦†
    Î“â€²  = ` âŸ¨GâŸ©C âˆ£ Î“
    tâ€²  = t
    Î“â‚œâ€² = Î“â€² at tâ€²
    Î“â†’Î“â€² : Î“â‚œ â€”[ Î± ]â†’â‚œ Î“â‚œâ€²
    Î“â†’Î“â€² = [Action] ([C-Advertise] vad hon dâŠ†) refl

    open Hâ‚ ğ•£ t Î± tâ€² Î“ Râ‰ˆ âŸ¨GâŸ©C Î“â†’Î“â€² âˆƒÎ“â‰ˆ
    ğ•£Ë¢ = RË¢ â¦Š Î»Ë¢

    Î“â€³ = âˆƒÎ“â‰ˆ .projâ‚ -- : Cfg
    Î“â‰ˆ = âˆƒÎ“â‰ˆ .projâ‚‚ -- : Î“â€³ â‰ˆ Î“â€²

    câˆˆÎ“â€² : âŸ¨ c , v âŸ©at x âˆˆá¶œ Î“â€²
    câˆˆÎ“â€² = âˆˆá¶œ-++âºÊ³ (` âŸ¨GâŸ©C) Î“ {!!}

    câˆˆÎ“â€³ : âŸ¨ c , v âŸ©at x âˆˆá¶œ Î“â€³
    -- câˆˆÎ“â€³ = âˆˆá¶œ-resp-â‰ˆ {Î“â€²}{Î“â€³} (â†­-sym Î“â‰ˆ) câˆˆÎ“â€²
    câˆˆÎ“â€³ = câˆˆ

    câˆˆâ€² : ğ•£Ë¢ âˆ™run â‰ˆâ‹¯ âŸ¨ c , v âŸ©at x â‹¯
    câˆˆâ€² = câˆˆÎ“â€³

    qed : ((ğ•£Ë¢ âˆ™) âˆ™txoutC câˆˆ) âˆ™value â‰¡ v
    qed = ?
... | _ = {!!}
-}
{-
... | [L] [2]  Râ‰ˆ âˆƒÎ“â‰ˆ asâ‰¡ Allâˆ‰ Honâ‡’ âˆƒB hâ‰¡ hâˆˆO unique-h hâ™¯sechash = {!!}
... | [L] [3]  Râ‰ˆ âˆƒÎ“â‰ˆ committedA Aâˆˆper âˆƒB = {!!}
... | [L] [4]  Râ‰ˆ âˆƒÎ“â‰ˆ fresh-z = {!!}
... | [L] [5]  dâ‰¡ Râ‰ˆ âˆƒÎ“â‰ˆ = {!!}
... | [L] [6]  tâ‰¡ dâ‰¡ Râ‰ˆ âˆƒÎ“â‰ˆ fresh-yâ€² pâŸ¦Î”âŸ§â‰¡ Asâ‰¡âˆ… = {!!}
... | [L] [7]  Râ‰ˆ âˆƒÎ“â‰ˆ fresh-ys âˆƒB âˆƒÎ± aâˆˆ âˆƒÎ» first-Î»á¶œ = {!!}
... | [L] [8]  tâ‰¡ dâ‰¡ Râ‰ˆ fresh-xs Asâ‰¡âˆ… âˆƒÎ“â‰ˆ = {!!}
... | [L] [9]  dâ‰¡ Râ‰ˆ âˆƒÎ“â‰ˆ frsg-x Asâ‰¡âˆ… âˆ€â‰¤t = {!!}
... | [L] [10] Râ‰ˆ âˆƒÎ“â‰ˆ âˆƒÎ» first-Î»á¶œ = {!!}
... | [L] [11] Râ‰ˆ âˆƒÎ“â‰ˆ fresh-y = {!!}
... | [L] [12] Râ‰ˆ âˆƒÎ“â‰ˆ âˆƒÎ» first-Î»á¶œ = {!!}
... | [L] [13] Râ‰ˆ âˆƒÎ“â‰ˆ fresh-ys = {!!}
... | [L] [14] Râ‰ˆ âˆƒÎ“â‰ˆ âˆƒÎ» first-Î»á¶œ = {!!}
... | [L] [15] Râ‰ˆ âˆƒÎ“â‰ˆ fresh-y = {!!}
... | [R] [16] Râ‰ˆ âˆƒÎ“â‰ˆ fresh-y T âŠ†ins Tâˆˆ first-Î»á¶œ Â¬coh = {!!}
... | [R] [17] Râ‰ˆ âˆƒÎ“â‰ˆ T âŠ†ins Â¬coh = {!!}
... | [L] [18] Î´>0 âˆƒÎ“â‰ˆ = {!!}
-}

-- _âˆˆáµ¤â‚œâ‚“â‚’_ : TxInputâ€² â†’ Blockchain â†’ Set
-- txi âˆˆáµ¤â‚œâ‚“â‚’ b = hashTxâ± txi âˆˆË¢ UTXO b

-- lemma6 :
--     (R~ : RË¢ ~ Rá¶œ) â†’ let ğ•£ = R~ .projâ‚ in
--     (câˆˆ : RË¢ â‰ˆâ‹¯ âŸ¨ c , v âŸ©at x â‹¯)
--     --â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
--   â†’ (ğ•£ âˆ™txoutC câˆˆ) âˆˆáµ¤â‚œâ‚“â‚’ ğ”¹ Rá¶œ

-- lemma6 (ğ•£ , base init Râ‰ˆ cinit txoutâ‰¡ sechashâˆ… Îºâˆ…) câˆˆ
--   = âŠ¥-elim
--   $ Initialâ‡’âˆ‰ init
--   $ câˆˆ :~ Râ‰ˆ âŸª (Î» â—† â†’ _ âˆˆá¶œ â—† .end .cfg) âŸ«

-- lemma6 (_ , stepâ‚ {âˆƒğ•£@(RË¢ , ğ•£)}{Î“â‚œ}{Rá¶œ}{Î»á¶œ}{ğ•’}{ğ•£â€²} R~ coh) câˆˆ
--   = {!!}

-- -- lemma6 {v = v} {x = x} {c = c} (ğ•£ , stepâ‚‚ {Î»á¶œ} R~ coh) câˆˆ
-- --   = let txi@((_ , _ , T) at o) , Tâˆˆ , â‰¡v , Tâ™¯â‰¡ = lemma6 (ğ•£ , R~) câˆˆ
-- --     in  txi , {!âˆˆ-âˆªâºË¡ (T â™¯ at o) (UTXO txs â”€ STXOâ‚œâ‚“ tx) (UTXOâ‚œâ‚“ tx) !} , â‰¡v , Tâ™¯â‰¡
-- -- lemma6 {RË¢}{Rá¶œ = ğ•“@(.(submit T) âˆ· ls)} {c = c} {v = v} {x = x}
-- --        (ğ•£@(record{ txoutâ€² = txout}) , stepâ‚‚ {Î»á¶œ = .(submit T)} R~ ([1] {T = T} insâ™¯)) câˆˆ
-- --   = let txi@((_ , _ , Tâ€²) at o) = ğ•£ âˆ™txoutC câˆˆ
-- --         Tâˆˆâ€² , â‰¡v , Tâ™¯â‰¡ = lemma6 (ğ•£ , R~) câˆˆ
-- --         Tâ‚’â€² = Tâ€² â™¯ at toâ„• o

-- --         Tâˆ‰ : Tâ‚’â€² âˆ‰Ë¢ STXOâ‚œâ‚“ T
-- --         Tâˆ‰ xâˆˆ =
-- --           let
-- --             xâˆˆâ€² : Tâ‚’â€² âˆˆ V.toList (T .projâ‚‚ .projâ‚‚ .inputs)
-- --             xâˆˆâ€² = âˆˆË¢-fromListâ» xâˆˆ

-- --             Î“âˆˆ : âŸ¨ c , v âŸ©at x âˆˆ allCfgs RË¢
-- --             Î“âˆˆ = {!!}

-- --             txiâ€² : TxInputâ€²
-- --             txiâ€² = Txoutâˆˆ txout {! endâˆˆallCfgsáµ— !} (here refl)

-- --             Tâ‚’âˆˆ : Tâ‚’â€² âˆˆ (hashTxâ± <$> codom txout)
-- --             Tâ‚’âˆˆ = {!!}
-- --           in
-- --             insâ™¯ (xâˆˆâ€² , Tâ‚’âˆˆ)

-- --         Tâˆˆ : Tâ‚’â€² âˆˆË¢ UTXO (ğ”¹ ğ•“)
-- --         Tâˆˆ = âˆˆ-âˆªâºË¡ Tâ‚’â€² (UTXO (ğ”¹ ls) â”€ STXOâ‚œâ‚“ T)
-- --                        (UTXOâ‚œâ‚“ T)
-- --                        (âˆˆ-â”€âº _ (UTXO $ ğ”¹ ls) (STXOâ‚œâ‚“ T) Tâˆˆâ€² Tâˆ‰)
-- --     in  txi , Tâˆˆ , â‰¡v , Tâ™¯â‰¡


-- -- lemma6 (ğ•£ , stepâ‚‚ {Î»á¶œ = .(A â†’Oâˆ¶ m)}  R~ ([2] {A = A}{m} (injâ‚ refl))) câˆˆ = lemma6 (ğ•£ , R~) câˆˆ
-- -- lemma6 (ğ•£ , stepâ‚‚ {Î»á¶œ = .(Oâ†’ A âˆ¶ m)} R~ ([2] {A = A}{m} (injâ‚‚ refl))) câˆˆ = lemma6 (ğ•£ , R~) câˆˆ
-- -- lemma6 (ğ•£ , stepâ‚‚ {Î»á¶œ = .(A â†’âˆ—âˆ¶ m)}  R~ ([3] {A}{m} _))               câˆˆ = lemma6 (ğ•£ , R~) câˆˆ
