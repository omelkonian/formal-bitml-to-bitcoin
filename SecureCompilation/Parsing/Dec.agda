open import Prelude.Init hiding (T)
open SetAsType
open import Prelude.Membership
open import Prelude.Lists
open import Prelude.Lists.Collections
open import Prelude.Lists.Dec
open import Prelude.General
open import Prelude.InferenceRules
open import Prelude.Lists.Dec
open import Prelude.DecEq
open import Prelude.Functor
open import Prelude.Decidable
open import Prelude.Nary
open import Prelude.Traces
open import Prelude.Validity
open import Prelude.Apartness

open import SecureCompilation.ModuleParameters using () renaming (â‹¯ to $â‹¯)
module SecureCompilation.Parsing.Dec ($â‹¯ : $â‹¯) (let open $â‹¯ $â‹¯) where

open import SymbolicModel â‹¯â€² as S
  hiding ( _âˆŽ; begin_
         {-variables-}
         ; Î“â‚€; Î“; Î“â€²; Î“â€³; Î“â‚œ; Î“â‚œâ€²; Î“â‚œâ€³; Î”
         ; R; Râ€²; RË¢; RË¢â€²
         ; A; B; Bâ€²
         ; G; C
         ; t; tâ€²; Î´; n
         ; ad; g; c; câ€²; cs; ds; d; vcs
         ; x; xâ€²; y; yâ€²; z; xs
         ; a; as
         ; v; vâ€²; vs
         ; Î±; p; Î£
         )
open import ComputationalModel â‹¯â€² finPart keypairs
  hiding ( `; âˆ£_âˆ£; _`âˆ§_; _`âˆ¨_; _`=_; _`<_; `true; âˆŽ
         ; Run; Time; Value; DecEq-Label
         ; HonestMoves; HonestStrategies; ParticipantStrategy
         ; Valid-Strategy; moves
         ; Î£
         ; module AdvM
         {-variables-}
         ; R; Râ€²; Râ€³; Rá¶œ
         ; tx; i; t; tâ€²; n; m; mâ€²; Î»á¶œ
         )
  renaming (Label to CLabel; Labels to CLabels)
open import Compiler â‹¯â€² Î·
open import Coherence $â‹¯

-- ** generating fresh variables
open import Prelude.InfEnumerable
postulate instance Enumâˆž-String : Enumerableâˆž String

-- ** collecting advertisement base-configurations
open import Prelude.Coercions
allAds : Cfg â†’ List Ad
allAds = mapMaybe go âˆ˜ to[ Cfgâ€² ]
  where
    go : BaseCfg â†’ Maybe Ad
    go (`` ad) = just ad
    go _      = nothing

postulate allAdsâˆˆ : âˆ€ {ad Î“} â†’ ad âˆˆ allAds Î“ â†’ ` ad âˆˆá¶œ Î“

allAdsÊ³ : Run â†’ List Ad
allAdsÊ³ R = allAds (R âˆ™cfg)

module _ {Î“â‚œ RË¢} {ð•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ Rá¶œ Î»á¶œ} where
  getAdâ‚ : Î“â‚œ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[1]~ Î»á¶œ â¨¾ Rá¶œ â†’ Ad
  getAdâ‚ (mkâ„ {h = h}) = let open Hâ‚-args h in ad

  getAd : Î“â‚œ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ â†’ Ad
  getAd (mkâ„ {h = h}) = let open Hâ‚„-args h in ad

  postulate
    getAdâˆˆallAdsâ‚ : âˆ€ p â†’ getAdâ‚ p âˆˆ allAdsÊ³ RË¢
    getAdâˆˆallAds  : âˆ€ p â†’ getAd p âˆˆ allAdsÊ³ RË¢

  getT : Î“â‚œ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ â†’ âˆƒTx
  getT (mkâ„ {h = h}) = let open Hâ‚„ h in -, -, T

  getM : Î“â‚œ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[1]~ Î»á¶œ â¨¾ Rá¶œ â†’ Message
  getM (mkâ„ {h = h}) =
    let
      open Hâ‚-args h hiding (RË¢) renaming (ad to âŸ¨GâŸ©C)
      txoutÎ“ = Txout Î“ âˆ‹ Txoutâ‰ˆ {RË¢ âˆ™cfg}{Î“} (Râ‰ˆ .projâ‚‚) (ð•£ âˆ™txoutEnd_)
      txoutG = Txout G âˆ‹ weaken-â†¦ txoutÎ“ (depositsâŠ†â‡’namesÊ³âŠ† {âŸ¨GâŸ©C}{Î“} dâŠ†)
      txoutC = Txout C âˆ‹ weaken-â†¦ txoutG (mapMaybe-âŠ† isInjâ‚‚ $ vad âˆ™names-âŠ†)
    in
      encodeAd âŸ¨GâŸ©C (txoutG , txoutC)

-- ** constrained versions of inductive case-relations
â¦…_â¦†_â¨¾_â¨¾_~â„[1]~_â¨¾_ : Ad â†’ StepRel
â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[1]~ Î»á¶œ â¨¾ Rá¶œ =
  âˆƒ Î» (p : Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[1]~ Î»á¶œ â¨¾ Rá¶œ) â†’
    getAdâ‚ p â‰¡ ad
â¦…_â¦†_â¨¾_â¨¾_~â„[4]~_â¨¾_ : Ad â†’ StepRel
â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ =
  âˆƒ Î» (p : Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ) â†’
    getAd p â‰¡ ad

-- ** postulated lemmas
â¦…adâ¦†âˆˆallAds : âˆ€ {ad RË¢ Rá¶œ Î“â‚œ Î»Ë¢ Î»á¶œ} {ð•£âˆ— : â„âˆ— RË¢}
  â†’ â¦… ad â¦† Î“â‚œ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ
  â†’ ad âˆˆ allAdsÊ³ RË¢
â¦…adâ¦†âˆˆallAds (h , refl) = getAdâˆˆallAds h

postulate
  getMâ‰¡ : âˆ€ {ad RË¢} {ð•£âˆ— : â„âˆ— RË¢} {Rá¶œ Î“â‚œ Î“â‚œâ€² Î»Ë¢ Î»Ë¢â€² A m mâ€²}
    â†’ (p  : â¦… ad â¦† Î“â‚œ  â¨¾ ð•£âˆ— â¨¾ Î»Ë¢  ~â„[1]~ A â†’âˆ—âˆ¶ m â¨¾ Rá¶œ)
    â†’ (pâ€² : â¦… ad â¦† Î“â‚œâ€² â¨¾ ð•£âˆ— â¨¾ Î»Ë¢â€² ~â„[1]~ A â†’âˆ—âˆ¶ mâ€² â¨¾ Rá¶œ)
    â†’ m â‰¡ mâ€²
  getTâ‰¡ : âˆ€ {ad RË¢} {ð•£âˆ— : â„âˆ— RË¢} {Rá¶œ Î“â‚œ Î“â‚œâ€² Î»Ë¢ Î»Ë¢â€² T Tâ€²}
    â†’ (p  : â¦… ad â¦† Î“â‚œ  â¨¾ ð•£âˆ— â¨¾ Î»Ë¢  ~â„[4]~ submit T â¨¾ Rá¶œ)
    â†’ (pâ€² : â¦… ad â¦† Î“â‚œâ€² â¨¾ ð•£âˆ— â¨¾ Î»Ë¢â€² ~â„[4]~ submit Tâ€² â¨¾ Rá¶œ)
    â†’ T â‰¡ Tâ€²
  dec-Râ‰ˆâ‚„ : âˆ€ RË¢ ad â†’ Dec $ âˆƒ Î» Î“â‚€ â†’ âˆƒ Î» t â†’
    let
      open âˆ£AD ad
      ds = persistentDeposits G
      vs = map selectâ‚‚ ds
      xs = map selectâ‚ƒ ds
      v  = sum vs
      Î“â‚ = Cfg âˆ‹ ` ad âˆ£ Î“â‚€
      Î“â‚‚ = Cfg âˆ‹ || map (Î»{ (Aáµ¢ , váµ¢ , xáµ¢) â†’
        âŸ¨ Aáµ¢ has váµ¢ âŸ©at xáµ¢ âˆ£ Aáµ¢ auth[ xáµ¢ â–·Ë¢  ad ] }) ds
      Î“â‚ƒ = Cfg âˆ‹ || map (_auth[ â™¯â–· ad ]) partG
    in
      RË¢ â‰ˆâ‹¯ Î“â‚ âˆ£ Î“â‚‚ âˆ£ Î“â‚ƒ at t

-- ** injectivity of constrained case-relations
Tâ‰¢â‡’Â¬Hâ‚ : âˆ€ {ad RË¢} {ð•£âˆ— : â„âˆ— RË¢} {Î“â‚œ Î»Ë¢ Rá¶œ A m mâ€²} â†’
  âˆ™ â¦… ad â¦† Î“â‚œ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[1]~ A â†’âˆ—âˆ¶ m â¨¾ Rá¶œ
  âˆ™ m â‰¢ mâ€²
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Â¬ (âˆƒ Î» Î“â‚œ â†’ âˆƒ Î» Î»Ë¢ â†’ â¦… ad â¦† Î“â‚œ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[1]~ A â†’âˆ—âˆ¶ mâ€² â¨¾ Rá¶œ)
Tâ‰¢â‡’Â¬Hâ‚ h mâ‰¢ (_ , _ , hâ€²) = mâ‰¢ $ getMâ‰¡ h hâ€²

Tâ‰¢â‡’Â¬Hâ‚„ : âˆ€ {ad RË¢} {ð•£âˆ— : â„âˆ— RË¢} {Î“â‚œ Î»Ë¢ Rá¶œ T Tâ€²} â†’
  âˆ™ â¦… ad â¦† Î“â‚œ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ submit T â¨¾ Rá¶œ
  âˆ™ T â‰¢ Tâ€²
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Â¬ (âˆƒ Î» Î“â‚œ â†’ âˆƒ Î» Î»Ë¢ â†’ â¦… ad â¦† Î“â‚œ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ submit Tâ€² â¨¾ Rá¶œ)
Tâ‰¢â‡’Â¬Hâ‚„ h Tâ‰¢ (_ , _ , hâ€²) = Tâ‰¢ $ getTâ‰¡ h hâ€²

Tâ‰¢â‡’Â¬Hâ‚„â€² : âˆ€ {ad RË¢} {ð•£âˆ— : â„âˆ— RË¢} {Î“â‚œ Î»Ë¢ Rá¶œ âˆƒT T Tâ€²} â†’
  âˆ™ â¦… ad â¦† Î“â‚œ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ submit T â¨¾ Rá¶œ
  âˆ™ âˆƒT â‰¡ T
  âˆ™ âˆƒT â‰¢ Tâ€²
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Â¬ (âˆƒ Î» Î“â‚œ â†’ âˆƒ Î» Î»Ë¢ â†’ â¦… ad â¦† Î“â‚œ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ submit Tâ€² â¨¾ Rá¶œ)
Tâ‰¢â‡’Â¬Hâ‚„â€² h refl = Tâ‰¢â‡’Â¬Hâ‚„ h

module _ (RË¢ : Run) (ð•£âˆ— : â„âˆ— RË¢) (Rá¶œ : CRun) where

  module _ (Aâ‚€ : Participant) (mâ‚€ : Message) (let Î»á¶œ = Aâ‚€ â†’âˆ—âˆ¶ mâ‚€) where
    âˆ€dec-Hâ‚ : âˆ€ ad â†’ Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’
      â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[1]~ Î»á¶œ â¨¾ Rá¶œ
    âˆ€dec-Hâ‚ ad
      with Â¿ Valid ad Â¿
         | Â¿ Any (_âˆˆ Hon) (ad .Ad.G âˆ™partG) Â¿
         | Â¿ ad âŠ†â¦… deposits â¦† (RË¢ âˆ™cfg) Â¿
    ... | _ | _ | no Â¬dâŠ†
      = no Î» where
        (_ , _ , mkâ„ {h = mk {Î“â‚€ = Î“â‚€} _ _ dâŠ† (_ â¨¾ _ â¨¾ _ âŠ£ Râ‰ˆ â‰ˆ _ âŠ£ _)} , refl) â†’
          Â¬dâŠ† (L.Perm.âˆˆ-resp-â†­ (â‰ˆâ‡’depositsâ†­ {Î“â‚€}{RË¢ âˆ™cfg} (â†­-sym $ Râ‰ˆ .projâ‚‚))  âˆ˜ dâŠ†)
    ... | no Â¬vad | _ | _
      = no Î» where (_ , _ , mkâ„ {h = mk vad _ _ _} , refl) â†’ Â¬vad vad
    ... | _ | no Â¬hon | _
      = no Î» where (_ , _ , mkâ„ {h = mk _ hon _ _} , refl) â†’ Â¬hon hon
    ... | yes vad | yes hon | yes dâŠ†
      = â‰«
      where
      t  = RË¢ .end .time
      Î“â‚€ = RË¢ âˆ™cfg
      Î“â€² = ` ad âˆ£ Î“â‚€

      h : Hâ‚-args
      h = mk {Î“â‚€ = Î“â‚€} vad hon dâŠ† record
        {ð•£âˆ— = ð•£âˆ—; Rá¶œ = Rá¶œ; Î“â€³ = Î“â€²; Râ‰ˆ = refl , â†­-refl; Î“â‰ˆ = â†­-refl}

      open Hâ‚-args h using (Î“; ð•’; Râ‰ˆ; ð•£; G; C; Î“â‚œâ€³)
      open Hâ‚ h using (Î»Ë¢)
      m =
        let
          txoutÎ“ = Txout Î“ âˆ‹ Txoutâ‰ˆ {RË¢ âˆ™cfg}{Î“} (Râ‰ˆ .projâ‚‚) (ð•£ âˆ™txoutEnd_)
          txoutG = Txout G âˆ‹ weaken-â†¦ txoutÎ“ (depositsâŠ†â‡’namesÊ³âŠ† {ad}{Î“} dâŠ†)
          txoutC = Txout C âˆ‹ weaken-â†¦ txoutG (mapMaybe-âŠ† isInjâ‚‚ $ vad âˆ™names-âŠ†)
        in
          encodeAd ad (txoutG , txoutC)

      ð•™ : Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ (ð•’ , Î»Ë¢) ~â„[1]~ Aâ‚€ â†’âˆ—âˆ¶ m â¨¾ Rá¶œ
      ð•™ = mkâ„ {h}

      ð•™-ad : â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ (ð•’ , Î»Ë¢) ~â„[1]~ Aâ‚€ â†’âˆ—âˆ¶ m â¨¾ Rá¶œ
      ð•™-ad = ð•™ , refl

      â‰« : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[1]~ Î»á¶œ â¨¾ Rá¶œ
      â‰« with m â‰Ÿ mâ‚€
      ... | no  mâ‰¢ = no  $ Tâ‰¢â‡’Â¬Hâ‚ ð•™-ad mâ‰¢
      ... | yes mâ‰¡ = yes $ -, -, QED
        where
        QED : â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ (ð•’ , Î»Ë¢) ~â„[1]~ Î»á¶œ â¨¾ Rá¶œ
        QED = ð•™-ad :~ mâ‰¡ âŸª (Î» â—† â†’ â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ (ð•’ , Î»Ë¢) ~â„[1]~ Aâ‚€ â†’âˆ—âˆ¶ â—† â¨¾ Rá¶œ) âŸ«

    dec-Hâ‚ : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[1]~ Î»á¶œ â¨¾ Rá¶œ
    dec-Hâ‚ with any? âˆ€dec-Hâ‚ (allAdsÊ³ RË¢)
    ... | yes pâˆˆ =
      let ad , _ , _ , p , _ = L.Any.satisfied pâˆˆ
      in yes (-, -, p)
    ... | no  pâˆ‰ = no Â¬QED
      where
      Â¬QED : Â¬_ $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[1]~ Î»á¶œ â¨¾ Rá¶œ
      Â¬QED (_ , _ , p) = pâˆ‰ pâˆˆ
        where
        ad = getAdâ‚ p
        adâˆˆ : ad âˆˆ allAdsÊ³ RË¢
        adâˆˆ = getAdâˆˆallAdsâ‚ p

        pâˆˆ : Any (Î» ad â†’ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[1]~ Î»á¶œ â¨¾ Rá¶œ)
                 (allAdsÊ³ RË¢)
        pâˆˆ = L.Any.map (Î» where refl â†’ -, -, p , refl) adâˆˆ

    -- similarly for the other cases
    postulate
      dec-Hâ‚‚ : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[2]~ Î»á¶œ â¨¾ Rá¶œ
      dec-Hâ‚ƒ : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[3]~ Î»á¶œ â¨¾ Rá¶œ
      dec-Hâ‚… : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[5]~ Î»á¶œ â¨¾ Rá¶œ
      dec-Hâ‚‡ : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[7]~ Î»á¶œ â¨¾ Rá¶œ
      dec-Hâ‚â‚€ : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[10]~ Î»á¶œ â¨¾ Rá¶œ
      dec-Hâ‚â‚‚ : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[12]~ Î»á¶œ â¨¾ Rá¶œ
      dec-Hâ‚â‚„ : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[14]~ Î»á¶œ â¨¾ Rá¶œ
      dec-Hâ‚â‚† : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[16]~ Î»á¶œ â¨¾ Rá¶œ

      Â¬H[1-14] :
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[1]~ Î»á¶œ â¨¾ Rá¶œ)
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[2]~ Î»á¶œ â¨¾ Rá¶œ)
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[3]~ Î»á¶œ â¨¾ Rá¶œ)
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[5]~ Î»á¶œ â¨¾ Rá¶œ)
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[7]~ Î»á¶œ â¨¾ Rá¶œ)
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[10]~ Î»á¶œ â¨¾ Rá¶œ)
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[12]~ Î»á¶œ â¨¾ Rá¶œ)
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[14]~ Î»á¶œ â¨¾ Rá¶œ)
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          âˆ€ Î“â‚œâ€³ Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ â‰â‚â‚ Î»á¶œ â¨¾ Rá¶œ

      Â¬H16â‡’â‰â‚ :
        Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[16]~ Î»á¶œ â¨¾ Rá¶œ)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        âˆ€ Î“â‚œâ€³ Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ â‰â‚ Î»á¶œ â¨¾ Rá¶œ

  module _ (Tâ‚€ : âˆƒTx) where
    Î»á¶œ = submit Tâ‚€

    âˆ€dec-Hâ‚„ : âˆ€ ad â†’ Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’
      â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ
    âˆ€dec-Hâ‚„ ad@(âŸ¨ G âŸ© C)
      with dec-Râ‰ˆâ‚„ RË¢ ad
    ... | no Râ‰‰ = no Â¬QED
      where
      Â¬QED : Â¬_ $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ
      Â¬QED (_ , _ , mkâ„ {h} , refl) =
        let open Hâ‚„-args h
        in  Râ‰‰ (Î“â‚€ , t , Râ‰ˆ)
    ... | yes (Î“â‚€ , t , Râ‰ˆ) = â‰«
      where
      ds = persistentDeposits G
      vs = map selectâ‚‚ ds
      xs = map selectâ‚ƒ ds
      v  = sum vs
      âˆƒfresh-z = fresh â¦ƒ Enumâˆž-String â¦„ (xs ++ ids Î“â‚€)
      z        = âˆƒfresh-z .projâ‚
      fresh-z  : z âˆ‰ xs ++ ids Î“â‚€
      fresh-z  = âˆƒfresh-z .projâ‚‚
      Î“â€²  = Cfg  âˆ‹ âŸ¨ C , v âŸ©at z âˆ£ Î“â‚€

      h : Hâ‚„-args
      h = mk {Î“â‚€ = Î“â‚€} fresh-z record
        {ð•£âˆ— = ð•£âˆ—; Rá¶œ = Rá¶œ; Î“â€³ = Î“â€²; Râ‰ˆ = Râ‰ˆ; Î“â‰ˆ = â†­-refl}

      open Hâ‚„-args h hiding (ð•£âˆ—; Rá¶œ; ad)
      open Hâ‚„ h using (Î»Ë¢; T)

      ð•™ : Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ (ð•’ , Î»Ë¢) ~â„[4]~ submit (-, -, T) â¨¾ Rá¶œ
      ð•™ = mkâ„ {h}

      abstract
        âˆƒT : âˆƒTx
        âˆƒT = -, -, T

        âˆƒTâ‰¡ : âˆƒT â‰¡ (-, -, T)
        âˆƒTâ‰¡ = refl

      ð•™-ad : â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ (ð•’ , Î»Ë¢) ~â„[4]~ submit (-, -, T) â¨¾ Rá¶œ
      ð•™-ad = ð•™ , refl

      â‰« : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ
      â‰« with Tâ‚€ â‰Ÿ âˆƒT
      ... | no Tâ‰¢
        = no Â¬QED
        where
        Â¬QED : Â¬_ $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ
        Â¬QED = Tâ‰¢â‡’Â¬Hâ‚„â€² ð•™-ad âˆƒTâ‰¡ (â‰¢-sym Tâ‰¢)
      ... | yes Tâ‰¡
        = yes $ -, -, QED
        where
        QED : â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ (ð•’ , Î»Ë¢) ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ
        QED = âŸª (Î» â—† â†’ â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ (ð•’ , Î»Ë¢) ~â„[4]~ submit â—† â¨¾ Rá¶œ) âŸ«
              trans Tâ‰¡ âˆƒTâ‰¡ ~: ð•™-ad

    dec-Hâ‚„ : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ
    dec-Hâ‚„ with any? âˆ€dec-Hâ‚„ (allAdsÊ³ RË¢)
    ... | yes pâˆˆ =
      let ad , _ , _ , p , _ = L.Any.satisfied pâˆˆ
      in yes (-, -, p)
    ... | no  pâˆ‰ = no Â¬QED
      where
      Â¬QED : Â¬_ $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ
      Â¬QED (_ , _ , p) = pâˆ‰ pâˆˆ
        where
        ad = getAd p
        adâˆˆ : ad âˆˆ allAdsÊ³ RË¢
        adâˆˆ = getAdâˆˆallAds p

        pâˆˆ : Any (Î» ad â†’ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ â¦… ad â¦† Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ)
                 (allAdsÊ³ RË¢)
        pâˆˆ = L.Any.map (Î» where refl â†’ -, -, p , refl) adâˆˆ

    -- similarly for the other cases
    postulate
      dec-Hâ‚† : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[6]~ Î»á¶œ â¨¾ Rá¶œ
      dec-Hâ‚ˆ : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[8]~ Î»á¶œ â¨¾ Rá¶œ
      dec-Hâ‚‰ : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[9]~ Î»á¶œ â¨¾ Rá¶œ
      dec-Hâ‚â‚ : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[11]~ Î»á¶œ â¨¾ Rá¶œ
      dec-Hâ‚â‚ƒ : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[13]~ Î»á¶œ â¨¾ Rá¶œ
      dec-Hâ‚â‚… : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[15]~ Î»á¶œ â¨¾ Rá¶œ
      dec-Hâ‚â‚‡ : Dec $ âˆƒ Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[17]~ Î»á¶œ â¨¾ Rá¶œ

      Â¬H[4-15] :
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ)
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[6]~ Î»á¶œ â¨¾ Rá¶œ)
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[8]~ Î»á¶œ â¨¾ Rá¶œ)
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[9]~ Î»á¶œ â¨¾ Rá¶œ)
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[11]~ Î»á¶œ â¨¾ Rá¶œ)
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[13]~ Î»á¶œ â¨¾ Rá¶œ)
        âˆ™ Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[15]~ Î»á¶œ â¨¾ Rá¶œ)
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          âˆ€ Î“â‚œâ€³ Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ â‰â‚â‚ Î»á¶œ â¨¾ Rá¶œ

      Â¬H17â‡’â™¯ : let open â„ (â„âˆ—â‡’â„ ð•£âˆ—) in
        Â¬ âˆƒ (Î» Î“â‚œâ€³ â†’ âˆƒ Î» Î»Ë¢ â†’ Î“â‚œâ€³ â¨¾ ð•£âˆ— â¨¾ Î»Ë¢ ~â„[17]~ Î»á¶œ â¨¾ Rá¶œ)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        âˆƒinputs Tâ‚€ â™¯ (hashTxâ± <$> codom txoutâ€²)
