open import Prelude.Init; open SetAsType
open import Prelude.Lists.Mappings
open import Prelude.InferenceRules
open import Prelude.Traces
open import Prelude.Apartness
open import Prelude.Functor

open import SecureCompilation.ModuleParameters using (â‹¯)

module Coherence.Relation (â‹¯ : â‹¯) (let open â‹¯ â‹¯) where

open import SymbolicModel â‹¯â€² as S
open import ComputationalModel â‹¯â€² finPart keypairs as C
open import Coherence.Hypotheses â‹¯

-- * Inductive case 1
data _â¨¾_â¨¾_~â‚â‚_â¨¾_ : StepRel where

  [1] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[1]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [2] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[2]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [3] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[3]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [4] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[4]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [5] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[5]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [6] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[6]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [7] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[7]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [8] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[8]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [9] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[9]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [10] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[10]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [11] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[11]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [12] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[12]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [13] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[13]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [14] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[14]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [15] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[15]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

  [18] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[18]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ

_â¨¾_â¨¾_â‰â‚â‚_â¨¾_ : StepRel
Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ â‰â‚â‚ Î»á¶œ â¨¾ Rá¶œ = Â¬ (Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ)

data _â¨¾_â¨¾_~â‚â‚‚_â¨¾_ : StepRel where

  [16] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[16]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚‚ Î»á¶œ â¨¾ Rá¶œ

  [17] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â„[17]~ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚‚ Î»á¶œ â¨¾ Rá¶œ

_â¨¾_â¨¾_â‰â‚â‚‚_â¨¾_ : StepRel
Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ â‰â‚â‚‚ Î»á¶œ â¨¾ Rá¶œ = Â¬ (Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚‚ Î»á¶œ â¨¾ Rá¶œ)

data _â¨¾_â¨¾_~â‚_â¨¾_ : StepRel where

  [L]_ : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚ Î»á¶œ â¨¾ Rá¶œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚  Î»á¶œ â¨¾ Rá¶œ

  [R] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    âˆ™ Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ â‰â‚â‚ Î»á¶œ â¨¾ Rá¶œ
    âˆ™ Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚â‚‚ Î»á¶œ â¨¾ Rá¶œ
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚  Î»á¶œ â¨¾ Rá¶œ

_â¨¾_â¨¾_â‰â‚_â¨¾_ : StepRel
Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ â‰â‚ Î»á¶œ â¨¾ Rá¶œ = Â¬ (Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚ Î»á¶œ â¨¾ Rá¶œ)

-- * Inductive case 2
data _~â‚‚_âˆ·Ê³_ : SRun â†’ CRun â†’ C.Label â†’ Type where

  [1] : âˆ€ {RË¢} {T : âˆƒTx} (let ğ•£ = â„âˆ—â‡’â„ (RË¢ .projâ‚‚); open â„ ğ•£) â†’
    T .projâ‚‚ .projâ‚‚ .inputs â™¯ (hashTxâ± <$> codom txoutâ€²)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    RË¢ ~â‚‚ Rá¶œ âˆ·Ê³ submit T

  [2] : âˆ€ {RË¢} â†’
    (Î»á¶œ â‰¡ A â†’Oâˆ¶ m) âŠ (Î»á¶œ â‰¡ Oâ†’ A âˆ¶ m)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    RË¢ ~â‚‚ Rá¶œ âˆ·Ê³ Î»á¶œ

  [2]â€² : âˆ€ {RË¢} â†’
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    RË¢ ~â‚‚ Rá¶œ âˆ·Ê³ delay 0

  [3] : âˆ€ {ğ•£âˆ— : â„âˆ— RË¢} â†’
    let Î»á¶œ = A â†’âˆ—âˆ¶ m in
    -- Î»á¶œ does not correspond to any symbolic move
    (âˆ€ Î“â‚œ Î»Ë¢ â†’ Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ â‰â‚ Î»á¶œ â¨¾ Rá¶œ)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (-, ğ•£âˆ—) ~â‚‚ Rá¶œ âˆ·Ê³ Î»á¶œ

data _~â€²_ : SRun â†’ CRun â†’ Type where

  -- * Base case
  base :
    âˆ€ {â„½ : â„¾áµ— Î“â‚œâ‚€} (let open â„¾áµ— â„½; Î“â‚€ = Î“â‚œâ‚€ .cfg)
      -- (i) RË¢ = Î“â‚€ âˆ£ 0, with Î“â‚€ initial
      (init : Initial Î“â‚œâ‚€)
      -- (ii) Rá¶œ = Tâ‚€ â‹¯ initial
      (cinit : Initial Rá¶œ) â†’
      -- (iii) generation of public keys, we do not consider that here
      -- (iv) âŸ¨A,vâŸ©â‚“ âˆˆ Î“â‚€ â‡’ txout{ x â†¦ (v$ spendable with KÌ‚(A)(râ‚)) âˆˆ Tâ‚€ }
    âˆ™ (âˆ€ {A v x} (dâˆˆ : âŸ¨ A has v âŸ©at x âˆˆá¶œ Î“â‚€) â†’
        let âˆƒTâ‚€ , _ = cinit; _ , o , Tâ‚€ = âˆƒTâ‚€ in
        âˆƒ Î» oáµ¢ â†’ (txoutÎ“ (depositâˆˆÎ“â‡’namesÊ³ {Î“ = Î“â‚€} dâˆˆ) â‰¡ âˆƒTâ‚€ at oáµ¢)
               Ã— (Tâ‚€ â€¼áµ’ oáµ¢ â‰¡ v redeemable-by KÌ‚ A))
      -- (v)  dom sechash = âˆ…
      -- (vi) dom Îº       = âˆ…
      -- by definition of Initial/â„
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      (-, â„½ âˆâŠ£ init âœ“) ~â€² Rá¶œ

  -- * Inductive case 1
  stepâ‚ : âˆ€ {RË¢} {ğ•£âˆ— : â„âˆ— RË¢} {Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ} â†’
    âˆ™ (-, ğ•£âˆ—) ~â€² Rá¶œ
    âˆ™ Î“â‚œ â¨¾ ğ•£âˆ— â¨¾ Î»Ë¢ ~â‚ Î»á¶œ â¨¾ Rá¶œ
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      (-, Î“â‚œ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“) ~â€² (Î»á¶œ âˆ· Rá¶œ âœ“)

  -- * Inductive case 2
  stepâ‚‚ : âˆ€ {RË¢} â†’
    âˆ™ RË¢ ~â€² Rá¶œ
    âˆ™ RË¢ ~â‚‚ Rá¶œ âˆ·Ê³ Î»á¶œ
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      RË¢ ~â€² (Î»á¶œ âˆ· Rá¶œ âœ“)

_~_ _â‰_ : S.Run â†’ CRun â†’ Type
RË¢ ~ Rá¶œ = âˆƒ Î» (ğ•£âˆ— : â„âˆ— RË¢) â†’ (-, ğ•£âˆ—) ~â€² Rá¶œ
_â‰_ = Â¬_ âˆ˜â‚‚ _~_

pattern [L1]_ h = [L] [1] h
pattern [L2]_ h = [L] [2] h
pattern [L3]_ h = [L] [3] h
pattern [L4]_ h = [L] [4] h
pattern [L5]_ h = [L] [5] h
pattern [L6]_ h = [L] [6] h
pattern [L7]_ h = [L] [7] h
pattern [L8]_ h = [L] [8] h
pattern [L9]_ h = [L] [9] h
pattern [L10]_ h = [L] [10] h
pattern [L11]_ h = [L] [11] h
pattern [L12]_ h = [L] [12] h
pattern [L13]_ h = [L] [13] h
pattern [L14]_ h = [L] [14] h
pattern [L15]_ h = [L] [15] h
pattern [L18]_ h = [L] [18] h
pattern [R16âŠ£_]_ Â¬coh h = [R] Â¬coh ([16] h)
pattern [R17âŠ£_]_ Â¬coh h = [R] Â¬coh ([17] h)

-- ** DSL for presenting coherence steps
infix 0 âˆ_âŠ£_,_~_âŠ£_âŠ£_
âˆ_âŠ£_,_~_âŠ£_âŠ£_ :
  âˆ€ Î“â‚œâ‚€ (init : Initial Î“â‚œâ‚€) (â„½â‚€ : â„¾áµ— Î“â‚œâ‚€) â†’
  âˆ€ (rá¶œ : C.Run) (cinit : Initial rá¶œ) â†’
  let open â„¾áµ— â„½â‚€; Î“â‚€ = Î“â‚œâ‚€ .cfg in
  (âˆ€ {A v x} (dâˆˆ : âŸ¨ A has v âŸ©at x âˆˆá¶œ Î“â‚€) â†’
      let âˆƒTâ‚€ , _ = cinit; _ , o , Tâ‚€ = âˆƒTâ‚€ in
      âˆƒ Î» oáµ¢ â†’ (txoutÎ“ (depositâˆˆÎ“â‡’namesÊ³ {Î“ = Î“â‚€} dâˆˆ) â‰¡ âˆƒTâ‚€ at oáµ¢)
            Ã— (Tâ‚€ â€¼áµ’ oáµ¢ â‰¡ v redeemable-by KÌ‚ A))
  â†’ (Î“â‚œâ‚€ âˆâŠ£ init) ~ (rá¶œ âˆâŠ£ cinit âœ“)
âˆ Î“â‚œ âŠ£ init , â„½â‚€ ~ Rá¶œ âŠ£ cinit âŠ£ txoutâ‰ˆ =
  -, base {â„½ = â„½â‚€} init cinit txoutâ‰ˆ

infixl -1 _â€”â†’_âŠ£_~_âŠ£_ _â€”â†’áµ‹_âŠ£_
_â€”â†’_âŠ£_~_âŠ£_ : âˆ€ {RË¢ Rá¶œ} (coh : RË¢ ~ Rá¶œ) Î“â‚œ (Î»Ë¢ : ğ•ƒ RË¢ Î“â‚œ) Î»á¶œ â†’
  Î“â‚œ â¨¾ coh .projâ‚ â¨¾ Î»Ë¢ ~â‚ Î»á¶œ â¨¾ Rá¶œ
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (Î“â‚œ âˆ· RË¢ âŠ£ Î»Ë¢ .projâ‚)       ~  (Î»á¶œ âˆ· Rá¶œ âœ“)
(ğ•£âˆ— , coh) â€”â†’ Î“â‚œ âŠ£ Î»Ë¢ ~ Î»á¶œ âŠ£ p =
  Î“â‚œ âˆ· ğ•£âˆ— âŠ£ Î»Ë¢ âœ“ , stepâ‚ {Î»Ë¢ = Î»Ë¢} coh p

_â€”â†’áµ‹_âŠ£_ : âˆ€ {RË¢ Rá¶œ} (coh : RË¢ ~ Rá¶œ) Î»á¶œ â†’
  (-, coh .projâ‚) ~â‚‚ Rá¶œ âˆ·Ê³ Î»á¶œ
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  RË¢              ~  (Î»á¶œ âˆ· Rá¶œ âœ“)
(ğ•£âˆ— , coh) â€”â†’áµ‹ Î»á¶œ âŠ£ p
  = ğ•£âˆ— , stepâ‚‚ coh p

private
  testPatternMatch-~ : RË¢ ~ Rá¶œ â†’ âŠ¤
  testPatternMatch-~ (ğ•£âˆ— , coh) with coh
  ... | base init cinit txoutâ‰ˆ = tt
  ... | stepâ‚‚ _ ([1] insâ™¯) = tt
  ... | stepâ‚‚ _ ([2] Î»á¶œâ‰¡) = tt
  ... | stepâ‚‚ _ [2]â€² = tt
  ... | stepâ‚‚ _ ([3] Â¬p) = tt
  ... | stepâ‚ _ p with p
  ... | [L1]  h = tt
  ... | [L2]  h = tt
  ... | [L3]  h = tt
  ... | [L4]  h = tt
  ... | [L5]  h = tt
  ... | [L6]  h = tt
  ... | [L7]  h = tt
  ... | [L8]  h = tt
  ... | [L9]  h = tt
  ... | [L10] h = tt
  ... | [L11] h = tt
  ... | [L12] h = tt
  ... | [L13] h = tt
  ... | [L14] h = tt
  ... | [L15] h = tt
  ... | [R16âŠ£ Â¬coh ] h = tt
  ... | [R17âŠ£ Â¬coh ] h = tt
  ... | [L18] h = tt
